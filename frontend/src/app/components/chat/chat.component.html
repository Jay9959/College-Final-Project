<div class="chat-container">
    <!-- Sidebar -->
    <aside class="sidebar" [class.mobile-hidden]="selectedUser">
        <div class="sidebar-header">
            <div class="user-info">
                <input type="file" #fileInput style="display: none" (change)="onFileSelected($event)" accept="image/*">

                <div class="avatar-container" (click)="fileInput.click()" title="Change Profile Picture">
                    <div *ngIf="!currentUser?.avatar" class="avatar">
                        {{ currentUser?.username?.charAt(0)?.toUpperCase() }}
                    </div>
                    <img *ngIf="currentUser?.avatar" [src]="getAvatarUrl(currentUser?.avatar)" class="avatar-img"
                        alt="{{ currentUser?.username }}" (error)="onAvatarError()">

                    <div class="edit-overlay">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z">
                            </path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                    </div>
                </div>
                <span class="username">{{ currentUser?.username }}</span>
            </div>
            <button class="logout-btn" (click)="onLogout()" title="Logout">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16,17 21,12 16,7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
            </button>
        </div>

        <div class="search-box">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" placeholder="Search or start new chat" [(ngModel)]="searchQuery">
        </div>

        <div class="users-list">
            <div *ngFor="let user of filteredUsers" class="user-item" [class.active]="selectedUser?._id === user._id"
                (click)="selectUser(user)">
                <div class="user-avatar">
                    <ng-container *ngIf="!user.avatar">
                        {{ user.username.charAt(0).toUpperCase() }}
                    </ng-container>
                    <img *ngIf="user.avatar" [src]="getAvatarUrl(user.avatar)" class="avatar-img"
                        style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;"
                        (error)="user.avatar = undefined">
                    <span class="status-dot" [class.online]="isUserOnline(user._id)"></span>
                </div>
                <div class="user-details">
                    <div class="user-name">{{ user.username }}</div>
                    <div class="user-status">{{ isUserOnline(user._id) ? 'Online' : 'Offline' }}</div>
                </div>
            </div>
            <div *ngIf="users.length === 0" class="no-users">
                <p>No users found</p>
                <small>Invite friends to chat!</small>
            </div>
        </div>
    </aside>

    <!-- Chat Area -->
    <main class="chat-area" [class.mobile-show]="selectedUser">
        <div *ngIf="!selectedUser" class="no-chat">
            <div class="no-chat-content">
                <svg width="100" height="100" viewBox="0 0 39 39">
                    <path fill="#00a884"
                        d="M10.7 32.8l.6.3c2.5 1.5 5.3 2.2 8.1 2.2 8.8 0 16-7.2 16-16 0-4.2-1.7-8.3-4.7-11.3s-7-4.7-11.3-4.7c-8.8 0-16 7.2-15.9 16.1 0 3 .9 5.9 2.4 8.4l.4.6-1.6 5.9 6-1.5z">
                    </path>
                    <path fill="#fff"
                        d="M32.4 6.4C29 2.9 24.3 1 19.5 1 9.3 1 1.1 9.3 1.2 19.4c0 3.2.9 6.3 2.4 9.1L1 38l9.7-2.5c2.7 1.5 5.7 2.2 8.7 2.2 10.1 0 18.3-8.3 18.3-18.4 0-4.9-1.9-9.5-5.3-12.9z">
                    </path>
                </svg>
                <h2>ChatApp Web</h2>
                <p>Select a chat to start messaging</p>
            </div>
        </div>

        <ng-container *ngIf="selectedUser">
            <div class="chat-header">
                <button class="back-btn" (click)="deselectUser()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m15 18-6-6 6-6" />
                    </svg>
                </button>
                <div class="chat-user-avatar">
                    <ng-container *ngIf="!selectedUser.avatar">
                        {{ selectedUser.username.charAt(0).toUpperCase() }}
                    </ng-container>
                    <img *ngIf="selectedUser.avatar" [src]="getAvatarUrl(selectedUser.avatar)" class="avatar-img"
                        style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;"
                        (error)="selectedUser.avatar = undefined">
                    <span class="status-dot" [class.online]="isUserOnline(selectedUser._id)"></span>
                </div>
                <div class="chat-user-info">
                    <div class="chat-user-name">{{ selectedUser.username }}</div>
                    <div class="chat-user-status">
                        <span *ngIf="typingUsers[selectedUser._id]" class="typing-indicator">typing...</span>
                        <span *ngIf="!typingUsers[selectedUser._id]">{{ isUserOnline(selectedUser._id) ? 'Online' :
                            'Last seen recently' }}</span>
                    </div>
                </div>
            </div>

            <div class="messages-container" #messagesContainer>
                <div *ngFor="let message of messages" class="message"
                    [class.sent]="message.sender._id === currentUser?._id"
                    [class.received]="message.sender._id !== currentUser?._id">
                    <div class="message-bubble">
                        <p class="message-text">{{ message.content }}</p>
                        <div class="message-meta">
                            <span class="message-time">{{ formatTime(message.createdAt) }}</span>
                            <span *ngIf="message.sender._id === currentUser?._id" class="message-status">
                                <span *ngIf="message.seen" class="tick seen">âœ“âœ“</span>
                                <span *ngIf="!message.seen && message.delivered" class="tick delivered">âœ“âœ“</span>
                                <span *ngIf="!message.seen && !message.delivered" class="tick">âœ“</span>
                            </span>
                        </div>
                    </div>
                </div>
                <div *ngIf="messages.length === 0" class="no-messages">
                    <p>No messages yet</p>
                    <small>Say hi to {{ selectedUser.username }}! ðŸ‘‹</small>
                </div>
            </div>

            <div class="message-input-container">
                <input type="text" placeholder="Type a message" [(ngModel)]="newMessage" (keyup.enter)="sendMessage()"
                    (input)="onTyping()">
                <button class="send-btn" (click)="sendMessage()" [disabled]="!newMessage.trim()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </button>
            </div>
        </ng-container>
    </main>
</div>