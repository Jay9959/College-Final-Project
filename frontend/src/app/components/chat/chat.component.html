<div class="chat-container">
    <!-- Sidebar -->
    <aside class="sidebar" [class.mobile-hidden]="selectedUser">
        <div class="sidebar-header">
            <div class="user-info">
                <input type="file" #fileInput style="display: none" (change)="onFileSelected($event)" accept="image/*">

                <div class="avatar-container" (click)="fileInput.click()" title="Change Profile Picture">
                    <div *ngIf="!currentUser?.avatar" class="avatar">
                        {{ currentUser?.username?.charAt(0)?.toUpperCase() }}
                    </div>
                    <img *ngIf="currentUser?.avatar" [src]="getAvatarUrl(currentUser?.avatar)" class="avatar-img"
                        alt="{{ currentUser?.username }}" (error)="onAvatarError()">

                    <div class="edit-overlay">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z">
                            </path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                    </div>
                </div>
                <span class="username">{{ currentUser?.fullName || currentUser?.username }}</span>
            </div>
            <button class="logout-btn" (click)="onLogout()" title="Logout">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16,17 21,12 16,7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
            </button>
        </div>

        <div class="search-box">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" placeholder="Search or start new chat" [(ngModel)]="searchQuery">
        </div>

        <div class="users-list">
            <div *ngFor="let user of filteredUsers" class="user-item" [class.active]="selectedUser?._id === user._id"
                (click)="selectUser(user)">
                <div class="user-avatar">
                    <ng-container *ngIf="!user.avatar">
                        {{ user.username.charAt(0).toUpperCase() }}
                    </ng-container>
                    <img *ngIf="user.avatar" [src]="getAvatarUrl(user.avatar)" class="avatar-img"
                        style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;"
                        (error)="user.avatar = undefined">
                    <span class="status-dot" [class.online]="isUserOnline(user._id)"></span>
                </div>
                <div class="user-details">
                    <div class="user-name">{{ user.fullName || user.username }}</div>
                    <div class="user-status">{{ isUserOnline(user._id) ? 'Online' : 'Offline' }}</div>
                </div>
            </div>
            <div *ngIf="users.length === 0" class="no-users">
                <p>No users found</p>
                <small>Invite friends to chat!</small>
            </div>
        </div>
    </aside>

    <!-- Chat Area -->
    <main class="chat-area" [class.mobile-show]="selectedUser">
        <div *ngIf="!selectedUser" class="no-chat">
            <div class="no-chat-content animate-fade-in">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="url(#gradient)" stroke-width="1.5">
                    <defs>
                        <linearGradient id="gradient" x1="0" y1="0" x2="24" y2="24" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#3b82f6" />
                            <stop offset="100%" stop-color="#8b5cf6" />
                        </linearGradient>
                    </defs>
                    <path
                        d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                    </path>
                </svg>
                <h2>Premium Chat</h2>
                <p>Select a conversation to start messaging.<br>Experience the future of connection.</p>
            </div>
        </div>

        <ng-container *ngIf="selectedUser">
            <div class="chat-header">
                <div class="chat-user-info-group">
                    <button class="back-btn" (click)="deselectUser()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="m15 18-6-6 6-6" />
                        </svg>
                    </button>

                    <div class="chat-user-avatar">
                        <img *ngIf="selectedUser.avatar" [src]="getAvatarUrl(selectedUser.avatar)"
                            style="width:100%; height:100%; border-radius:14px; object-fit:cover;">
                        <span *ngIf="!selectedUser.avatar">{{ selectedUser.username.charAt(0).toUpperCase() }}</span>
                    </div>

                    <div class="chat-user-text">
                        <div class="chat-user-name">{{ selectedUser.fullName || selectedUser.username }}</div>
                        <div class="chat-user-status">
                            <span *ngIf="typingUsers[selectedUser._id]" class="typing-indicator">typing...</span>
                            <span *ngIf="!typingUsers[selectedUser._id] && isUserOnline(selectedUser._id)">
                                <span class="online-indicator"></span> Online
                            </span>
                            <span
                                *ngIf="!typingUsers[selectedUser._id] && !isUserOnline(selectedUser._id)">Offline</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="messages-container" #messagesContainer>
                <div *ngFor="let message of messages" class="message"
                    [class.sent]="message.sender._id === currentUser?._id"
                    [class.received]="message.sender._id !== currentUser?._id">
                    <div class="message-bubble">
                        <!-- Text Message -->
                        <p *ngIf="message.messageType === 'text' || !message.messageType" class="message-text">{{
                            message.content }}</p>

                        <!-- Image Message -->
                        <div *ngIf="message.messageType === 'image'" class="message-image">
                            <img [src]="getAvatarUrl(message.fileUrl)" alt="Image"
                                style="max-width: 150px; max-height: 200px; object-fit: cover; border-radius: 12px; cursor: pointer;">
                        </div>

                        <!-- Video Message -->
                        <div *ngIf="message.messageType === 'video'" class="message-video">
                            <video controls [src]="getAvatarUrl(message.fileUrl)"
                                style="max-width: 250px; max-height: 250px; border-radius: 12px;"></video>
                        </div>

                        <!-- Generic File Message -->
                        <div *ngIf="message.messageType === 'file'" class="message-file"
                            style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                            <a [href]="getAvatarUrl(message.fileUrl)" target="_blank"
                                style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 10px;">
                                <div class="file-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                                        <polyline points="13 2 13 9 20 9"></polyline>
                                    </svg>
                                </div>
                                <div class="file-info" style="display: flex; flex-direction: column;">
                                    <span class="file-name" style="font-weight: 500;">{{ message.content }}</span>
                                    <span class="file-label" style="font-size: 0.8em; opacity: 0.8;">Click to
                                        open</span>
                                </div>
                            </a>
                        </div>

                        <!-- Audio Message -->
                        <div *ngIf="message.messageType === 'audio'" class="message-audio">
                            <audio controls [src]="getAvatarUrl(message.fileUrl)" style="max-width: 200px;"></audio>
                        </div>

                        <div class="message-meta">
                            <span class="message-time">{{ formatTime(message.createdAt) }}</span>
                            <span *ngIf="message.sender._id === currentUser?._id && !message.uploadProgress"
                                class="message-status">
                                <span *ngIf="message.seen" class="tick seen">✓✓</span>
                                <span *ngIf="!message.seen && message.delivered" class="tick delivered">✓✓</span>
                                <span *ngIf="!message.seen && !message.delivered" class="tick">✓</span>
                            </span>
                        </div>

                        <!-- Upload Progress Overlay -->
                        <div *ngIf="message.uploadProgress !== undefined" class="upload-overlay"
                            style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); border-radius: inherit; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                            <div class="spinner"
                                style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-bottom: 5px;">
                            </div>
                            <span style="color: white; font-size: 0.7em; font-weight: bold;">{{ message.uploadProgress
                                }}%</span>
                        </div>
                    </div>
                </div>
                <div *ngIf="messages.length === 0" class="no-messages"
                    style="text-align:center; color:rgba(255,255,255,0.3); margin-top:40px;">
                    <p>No messages yet</p>
                    <small>Start the conversation!</small>
                </div>
            </div>

            <div class="message-input-container">
                <!-- Emoji Picker -->
                <div *ngIf="showEmojiPicker" class="emoji-picker">
                    <span *ngFor="let emoji of emojis" (click)="addEmoji(emoji)">{{ emoji }}</span>
                </div>

                <div class="input-wrapper">
                    <button class="action-btn" (click)="chatFileInput.click()" title="Attach File">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M12 5v14M5 12h14" />
                        </svg>
                    </button>
                    <!-- Separate input for chat files -->
                    <input type="file" #chatFileInput style="display: none" (change)="onChatFileSelected($event)">

                    <button class="action-btn" (click)="toggleEmojiPicker()" title="Emoji">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                            <line x1="9" y1="9" x2="9.01" y2="9"></line>
                            <line x1="15" y1="9" x2="15.01" y2="9"></line>
                        </svg>
                    </button>

                    <input type="text" [placeholder]="isRecording ? 'Recording audio...' : 'Type your message...'"
                        [(ngModel)]="newMessage" (keyup.enter)="sendMessage()" (input)="onTyping()"
                        [disabled]="isRecording">

                    <!-- Mic / Stop Button -->
                    <button class="action-btn" *ngIf="!newMessage.trim()"
                        (click)="isRecording ? stopRecording() : startRecording()"
                        [title]="isRecording ? 'Stop Recording' : 'Record Audio'"
                        [style.color]="isRecording ? '#ef4444' : ''"
                        [style.animation]="isRecording ? 'pulse 1.5s infinite' : ''">
                        <svg *ngIf="!isRecording" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <line x1="12" y1="19" x2="12" y2="23"></line>
                            <line x1="8" y1="23" x2="16" y2="23"></line>
                        </svg>
                        <svg *ngIf="isRecording" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <rect x="6" y="6" width="12" height="12" rx="2" fill="currentColor"></rect>
                        </svg>
                    </button>

                    <!-- Send Button (only when text present) -->
                    <button class="send-btn" *ngIf="newMessage.trim()" (click)="sendMessage()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                </div>
            </div>
        </ng-container>
    </main>

    <!-- File Preview Modal -->
    <div class="modal-overlay" *ngIf="previewFile">
        <div class="preview-modal animate-scale-in">
            <div class="preview-header">
                <h3>Send Attachment?</h3>
                <button class="close-btn" (click)="cancelPreview()">×</button>
            </div>

            <div class="preview-content">
                <img *ngIf="previewUrl && previewFile?.type?.startsWith('image/')" [src]="previewUrl" alt="Preview">
                <video *ngIf="previewUrl && previewFile?.type?.startsWith('video/')" [src]="previewUrl" controls
                    style="max-width: 100%; max-height: 300px;"></video>
                <div *ngIf="!previewUrl" class="file-icon">
                    <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="1.5">
                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                        <polyline points="13 2 13 9 20 9"></polyline>
                    </svg>
                    <span>{{ previewFile.name }}</span>
                    <small>{{ (previewFile.size / 1024 / 1024).toFixed(2) }} MB</small>
                </div>
            </div>

            <div class="preview-actions">
                <button class="cancel-btn" (click)="cancelPreview()">Cancel</button>
                <button class="confirm-btn" (click)="confirmSendFile()">
                    Send
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>