<div class="chat-container">
    <!-- Sidebar -->
    <aside class="sidebar" [class.mobile-hidden]="selectedUser">
        <!-- New App Brand Header -->
        <div class="app-logo-header">
            <img src="assets/logo.svg" class="app-logo" alt="ChatApp Logo">
            <span class="app-name">ChatApp</span>
        </div>

        <div class="sidebar-header">
            <div class="user-info">
                <input type="file" #fileInput style="display: none" (change)="onFileSelected($event)" accept="image/*">

                <div class="avatar-container" (click)="openSettings('profile')" title="View Profile">
                    <div *ngIf="!currentUser?.avatar" class="avatar">
                        {{ (currentUser?.username || '').charAt(0).toUpperCase() }}
                    </div>
                    <img *ngIf="currentUser?.avatar" [src]="getProfileAvatar(currentUser)" class="avatar-img"
                        alt="{{ currentUser?.username }}" (error)="onAvatarError()">

                    <div class="edit-overlay">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z">
                            </path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                    </div>
                </div>
                <span class="username">{{ currentUser?.fullName || currentUser?.username }}</span>
            </div>


            <div class="header-actions">
                <button class="icon-btn" (click)="openSettings()" title="Settings">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                        </path>
                    </svg>
                </button>

            </div>
        </div>

        <div class="search-box">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" placeholder="Search or start new chat" [(ngModel)]="searchQuery">
        </div>

        <div class="users-list">
            <div *ngFor="let user of filteredUsers" class="user-item" [class.active]="selectedUser?._id === user._id"
                (click)="selectUser(user)">
                <div class="user-avatar" [class.group-avatar]="user.isGroup">
                    <img *ngIf="user.avatar"
                        [src]="(user.isGroup && user?.avatar?.startsWith('data:')) ? user?.avatar : getAvatarUrl(user?.avatar)"
                        class="avatar-img" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;"
                        (error)="handleImageError($event)">

                    <div class="avatar-fallback" [style.display]="user.avatar ? 'none' : 'flex'"
                        style="width: 100%; height: 100%; align-items: center; justify-content: center;">
                        <svg *ngIf="user.isGroup" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span *ngIf="!user.isGroup">{{ (user?.username || '').charAt(0).toUpperCase() }}</span>
                    </div>
                    <span *ngIf="!user.isGroup" class="status-dot" [class.online]="isUserOnline(user._id)"></span>
                </div>
                <div class="user-details">
                    <div class="user-name">{{ user.fullName || user.username }}</div>
                    <div class="user-status">{{ user.isGroup ? 'Group' : (isUserOnline(user._id) ? 'Online' : 'Offline')
                        }}</div>
                </div>
                <!-- Unread Message Count Badge -->
                <div class="unread-badge" *ngIf="user.unreadCount && user.unreadCount > 0">
                    {{ user.unreadCount > 99 ? '99+' : user.unreadCount }}
                </div>
            </div>
            <div *ngIf="users.length === 0" class="no-users">
                <p>No users found</p>
                <small>Invite friends to chat!</small>
            </div>
        </div>
    </aside>

    <!-- Chat Area -->
    <main class="chat-area" [class.mobile-show]="selectedUser">
        <!-- Wallpaper Background -->
        <div class="chat-wallpaper" [style.background-color]="chatSettings.wallpaper.color || '#0b141a'"
            [style.background-image]="chatSettings.wallpaper.image ? 'url(' + chatSettings.wallpaper.image + ')' : null"
            [class.has-doodles]="chatSettings.wallpaper.doodles && !chatSettings.wallpaper.image">
        </div>
        <div *ngIf="!selectedUser" class="no-chat">
            <div class="no-chat-content animate-fade-in">
                <img src="assets/logo.svg" alt="ChatApp Logo"
                    style="width: 120px; height: 120px; margin-bottom: 24px; filter: drop-shadow(0 0 40px rgba(0, 242, 254, 0.4));">
                <h2>Chat</h2>
                <p>Select a conversation to start messaging.</p>
            </div>
        </div>

        <ng-container *ngIf="selectedUser">
            <div class="chat-header">
                <div class="chat-user-info-group">
                    <button class="back-btn" (click)="deselectUser()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="m15 18-6-6 6-6" />
                        </svg>
                    </button>

                    <div class="chat-user-avatar" [class.group-avatar]="selectedUser.isGroup"
                        (click)="selectedUser.isGroup ? openGroupInfo() : openContactInfo()" style="cursor: pointer;">
                        <img *ngIf="selectedUser.avatar"
                            [src]="(selectedUser.isGroup && selectedUser.avatar && selectedUser.avatar.startsWith('data:')) ? selectedUser.avatar : getAvatarUrl(selectedUser.avatar)"
                            style="width:100%; height:100%; border-radius:14px; object-fit:cover;"
                            (error)="handleImageError($event)">

                        <div class="avatar-fallback" [style.display]="selectedUser.avatar ? 'none' : 'flex'"
                            style="width: 100%; height: 100%; align-items: center; justify-content: center;">
                            <svg *ngIf="selectedUser.isGroup" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            <span *ngIf="!selectedUser.isGroup">{{ (selectedUser.username ||
                                '').charAt(0).toUpperCase() }}</span>
                        </div>
                    </div>

                    <div class="chat-user-text" (click)="selectedUser.isGroup ? openGroupInfo() : openContactInfo()"
                        style="cursor: pointer;">
                        <div class="chat-user-name">
                            {{ selectedUser.fullName || selectedUser.username }}
                            <svg *ngIf="selectedUser && mutedChats.has(selectedUser._id)" width="14" height="14"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                style="margin-left: 5px; opacity: 0.6; display: inline-block; vertical-align: middle;">
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                                <line x1="1" y1="1" x2="23" y2="23"></line>
                            </svg>
                        </div>
                        <div class="chat-user-status">
                            <ng-container *ngIf="!selectedUser.isGroup">
                                <span *ngIf="selectedUser && typingUsers[selectedUser._id]"
                                    class="typing-indicator">typing...</span>
                                <span
                                    *ngIf="selectedUser && !typingUsers[selectedUser._id] && isUserOnline(selectedUser._id)">
                                    <span class="online-indicator"></span> Online
                                </span>
                                <span
                                    *ngIf="selectedUser && !typingUsers[selectedUser._id] && !isUserOnline(selectedUser._id)">Offline</span>
                            </ng-container>
                            <ng-container *ngIf="selectedUser.isGroup">
                                <span>Group</span>
                            </ng-container>
                        </div>
                    </div>

                    <!-- Call Dropdown Menu -->
                    <div class="call-dropdown-wrapper">
                        <button class="call-trigger-btn" (click)="toggleCallMenu()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polygon points="23 7 16 12 23 17 23 7"></polygon>
                                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                            </svg>
                            <span>Call</span>
                            <svg class="chevron" [class.open]="showCallMenu" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>

                        <!-- Call Dropdown Menu -->
                        <div class="call-dropdown-menu" *ngIf="showCallMenu">
                            <!-- User Profile Section -->
                            <div class="call-user-section">
                                <div class="call-user-avatar">
                                    <img *ngIf="selectedUser.avatar" [src]="getAvatarUrl(selectedUser.avatar)">
                                    <span *ngIf="!selectedUser.avatar">{{ selectedUser.username.charAt(0).toUpperCase()
                                        }}</span>
                                </div>
                                <span class="call-user-name">{{ selectedUser.fullName || selectedUser.username }}</span>
                                <svg *ngIf="mutedChats.has(selectedUser!._id)" width="14" height="14"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    style="margin-left: 5px; opacity: 0.6;">
                                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                                    <line x1="1" y1="1" x2="23" y2="23"></line>
                                </svg>
                            </div>

                            <!-- Voice and Video Buttons -->
                            <div class="call-buttons-row">
                                <button class="call-action-btn voice" (click)="onVoiceCall(); showCallMenu = false;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path
                                            d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z">
                                        </path>
                                    </svg>
                                    <span>Voice</span>
                                </button>
                                <button class="call-action-btn video" (click)="onVideoCall(); showCallMenu = false;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <polygon points="23 7 16 12 23 17 23 7"></polygon>
                                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                                    </svg>
                                    <span>Video</span>
                                </button>
                            </div>

                            <!-- Additional Options -->
                            <div class="call-options-list">
                                <div class="call-option" (click)="handleCallOption('groupCall')">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="9" cy="7" r="4"></circle>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                    </svg>
                                    <span>New group call</span>
                                </div>
                                <div class="call-option" (click)="handleCallOption('callLink')">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                                    </svg>
                                    <span>Send call link</span>
                                </div>
                                <div class="call-option" (click)="handleCallOption('scheduleCall')">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="16" y1="2" x2="16" y2="6"></line>
                                        <line x1="8" y1="2" x2="8" y2="6"></line>
                                        <line x1="3" y1="10" x2="21" y2="10"></line>
                                    </svg>
                                    <span>Schedule call</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Search Button -->
                    <button class="header-icon-btn" (click)="toggleChatSearch()" title="Search in chat">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </button>

                    <!-- 3-dot Menu -->
                    <div class="more-menu-wrapper">
                        <button class="header-icon-btn" (click)="toggleMoreMenu()" title="More options">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="5" r="2"></circle>
                                <circle cx="12" cy="12" r="2"></circle>
                                <circle cx="12" cy="19" r="2"></circle>
                            </svg>
                        </button>

                        <!-- More Menu Dropdown -->
                        <div class="more-dropdown-menu" *ngIf="showMoreMenu">
                            <div class="more-option" (click)="openLinkDeviceModal()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
                                    <line x1="12" y1="18" x2="12.01" y2="18"></line>
                                </svg>
                                <span>Link with Mobile</span>
                            </div>
                            <div class="more-option" (click)="handleMoreOption('newGroup')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                <span>New group</span>
                            </div>
                            <div class="more-option" (click)="handleMoreOption('selectMessages')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polyline points="9 11 12 14 22 4"></polyline>
                                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                                </svg>
                                <span>Select messages</span>
                            </div>
                            <div class="more-option" (click)="handleMoreOption('muteNotifications')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                                    <line x1="1" y1="1" x2="23" y2="23"></line>
                                </svg>
                                <span>Mute notifications</span>
                            </div>
                            <div class="more-option divider"></div>
                            <div class="more-option" (click)="handleMoreOption('clearChat')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                    </path>
                                </svg>
                                <span>Clear chat</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Search Bar -->
            <div class="chat-search-bar" *ngIf="showChatSearch">
                <div class="search-input-wrapper">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" [(ngModel)]="chatSearchQuery" (input)="onChatSearch()"
                        placeholder="Search messages..." autofocus>
                    <button class="close-search-btn" (click)="closeChatSearch()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="search-results-info" *ngIf="chatSearchQuery">
                    <span *ngIf="searchResultCount > 0">{{ currentSearchIndex + 1 }} of {{ searchResultCount }}
                        results</span>
                    <span *ngIf="searchResultCount === 0">No results found</span>
                    <div class="search-nav-btns" *ngIf="searchResultCount > 0">
                        <button (click)="prevSearchResult()" [disabled]="currentSearchIndex === 0">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="18 15 12 9 6 15"></polyline>
                            </svg>
                        </button>
                        <button (click)="nextSearchResult()" [disabled]="currentSearchIndex >= searchResultCount - 1">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Call Modal Component -->
            <app-call-modal #callModal [currentUser]="currentUser"></app-call-modal>

            <div class="messages-container" #messagesContainer>
                <div *ngFor="let message of messages; let i = index" class="message" [id]="'msg-' + message._id"
                    [class.sent]="message.sender._id === currentUser?._id"
                    [class.received]="message.sender._id !== currentUser?._id" [class.selecting]="isSelectMode"
                    [class.selected]="selectedMessages.has(message._id)"
                    (click)="isSelectMode && toggleMessageSelection(message)"
                    (contextmenu)="onMessageContextMenu($event, message)">

                    <!-- Selection Checkbox -->
                    <div class="selection-checkbox" *ngIf="isSelectMode">
                        <div class="checkbox" [class.checked]="selectedMessages.has(message._id)">
                            <svg *ngIf="selectedMessages.has(message._id)" width="14" height="14" viewBox="0 0 24 24"
                                fill="none" stroke="white" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </div>
                    </div>

                    <div class="message-bubble">
                        <!-- Reply Context (Quoted Message) -->
                        <div class="quoted-message" *ngIf="message.replyTo"
                            (click)="scrollToMessage(message.replyTo._id)">
                            <div class="quoted-sender"
                                [style.color]="message.replyTo.sender._id === currentUser?._id ? '#00a884' : '#53bdeb'">
                                {{ message.replyTo.sender._id === currentUser?._id ? 'You' :
                                message.replyTo.sender.username }}
                            </div>
                            <div class="quoted-text">{{ message.replyTo.content || 'Media' }}</div>
                        </div>

                        <!-- Reply Action Button (Hover) -->
                        <button class="message-reply-btn" (click)="setReply(message)" title="Reply">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="9 17 4 12 9 7"></polyline>
                                <path d="M20 18v-2a4 4 0 0 0-4-4H4"></path>
                            </svg>
                        </button>
                        <!-- Text Message -->
                        <p *ngIf="message.messageType === 'text' || !message.messageType" class="message-text">
                            {{ message.content }}
                        </p>

                        <!-- Translation Display -->
                        <div *ngIf="isTranslating[message._id]"
                            style="font-size: 0.8rem; color: var(--text-muted); padding: 4px 0; font-style: italic;">
                            Translating...
                        </div>
                        <div *ngIf="translatedMessages[message._id]"
                            style="margin-top: 6px; padding-top: 6px; border-top: 1px dashed rgba(255,255,255,0.2);">
                            <div style="font-size: 0.75rem; color: var(--accent-primary); margin-bottom: 2px;">
                                Translated:</div>
                            <p style="margin: 0; font-size: 0.95em;">{{ translatedMessages[message._id] }}</p>
                        </div>

                        <!-- Image Message -->
                        <div *ngIf="message.messageType === 'image'" class="message-image">
                            <!-- Show Image if auto-downloaded or manually downloaded -->
                            <img *ngIf="shouldShowMedia(message)" [src]="getAvatarUrl(message.fileUrl)" alt="Image"
                                (click)="downloadFile(message.fileUrl)" title="Click to open"
                                (contextmenu)="$event.stopPropagation()"
                                style="max-width: 150px; max-height: 200px; object-fit: cover; border-radius: 12px; cursor: pointer;">

                            <!-- Download Placeholder -->
                            <div *ngIf="!shouldShowMedia(message)" class="media-placeholder"
                                (click)="downloadMedia(message)">
                                <div class="download-icon-wrapper">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                </div>
                                <span>Photo â€¢ Click to download</span>
                            </div>
                        </div>

                        <!-- Video Message -->
                        <div *ngIf="message.messageType === 'video'" class="message-video">
                            <video *ngIf="shouldShowMedia(message)" controls [src]="getAvatarUrl(message.fileUrl)"
                                (contextmenu)="$event.stopPropagation()"
                                style="max-width: 250px; max-height: 250px; border-radius: 12px;"></video>

                            <!-- Download Placeholder -->
                            <div *ngIf="!shouldShowMedia(message)" class="media-placeholder"
                                (click)="downloadMedia(message)">
                                <div class="download-icon-wrapper">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                </div>
                                <span>Video â€¢ Click to download</span>
                            </div>
                        </div>

                        <!-- Generic File Message (WhatsApp Style) -->
                        <div *ngIf="message.messageType === 'file'" class="whatsapp-file-card">
                            <div class="file-card-content">
                                <div class="file-icon-large" [ngClass]="getFileIconClass(message.content)">
                                    <span class="file-ext">{{ getFileExtension(message.content) }}</span>
                                </div>
                                <div class="file-details-text">
                                    <span class="file-name-text">{{ message.content }}</span>
                                    <span class="file-meta-text">
                                        {{ getFileExtension(message.content) }} â€¢ FILE
                                    </span>
                                </div>
                            </div>

                            <div class="file-card-divider"></div>

                            <!-- Actions -->
                            <div class="file-card-actions">
                                <ng-container *ngIf="shouldShowMedia(message)">
                                    <button class="action-text-btn" (click)="openFile(message.fileUrl)">OPEN</button>
                                    <div class="action-separator"></div>
                                    <button class="action-text-btn"
                                        (click)="saveAsFile(message.fileUrl, message.content)">SAVE AS...</button>
                                </ng-container>

                                <ng-container *ngIf="!shouldShowMedia(message)">
                                    <button class="action-text-btn" (click)="downloadMedia(message)"
                                        style="width: 100%">DOWNLOAD</button>
                                </ng-container>
                            </div>
                        </div>

                        <!-- Audio Message -->
                        <div *ngIf="message.messageType === 'audio'" class="message-audio">
                            <audio *ngIf="shouldShowMedia(message)" controls [src]="getAvatarUrl(message.fileUrl)"
                                style="max-width: 200px;"></audio>
                            <!-- Download Placeholder -->
                            <div *ngIf="!shouldShowMedia(message)" class="media-placeholder small"
                                (click)="downloadMedia(message)">
                                <div class="download-icon-wrapper small">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                </div>
                                <span>Audio â€¢ Download</span>
                            </div>
                        </div>

                        <!-- Call Log Message -->
                        <div class="call-log-bubble" *ngIf="message.messageType === 'call_log'" (click)="onVideoCall()">
                            <div class="call-log-icon" [class.missed]="message.content?.includes('Missed')"
                                [class.ended]="!message.content?.includes('Missed')">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" *ngIf="message.content?.includes('Missed')">
                                    <path d="M23 7l-7 5 7 5V7z"></path>
                                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                                    <line x1="1" y1="1" x2="23" y2="23" stroke="currentColor" stroke-width="2"></line>
                                    <!-- Simple strikethrough or arrow -->
                                </svg>
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" *ngIf="!message.content?.includes('Missed')">
                                    <path
                                        d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z">
                                    </path>
                                </svg>
                            </div>
                            <div class="call-log-content">
                                <div class="call-log-title">{{ message.content }}</div>
                                <div class="call-log-subtitle">{{ message.content?.includes('Missed') ? 'Click to call
                                    back' : 'Tap to call again' }}</div>
                            </div>
                        </div>

                        <!-- Poll Message -->
                        <div *ngIf="message.messageType === 'poll'" class="poll-message">
                            <ng-container *ngIf="getPollData(message) as poll">
                                <div class="poll-question">ðŸ“Š {{ poll.question }}</div>
                                <div class="poll-option" *ngFor="let option of poll.options; let i = index"
                                    [class.selected]="isPollOptionSelected(message._id, i)"
                                    (click)="votePollOption(message, i); $event.stopPropagation()">
                                    <div class="option-radio">
                                        <svg *ngIf="isPollOptionSelected(message._id, i)" width="12" height="12"
                                            viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </div>
                                    <span class="option-text">{{ option.text }}</span>
                                    <span class="vote-count" *ngIf="option.votes?.length">{{ option.votes.length
                                        }}</span>
                                </div>
                                <div class="poll-votes">
                                    {{ getTotalPollVotes(message) }} vote(s) â€¢ {{ poll.options.length }} options
                                </div>
                            </ng-container>
                        </div>

                        <div class="message-meta">
                            <svg *ngIf="message.isPinned" class="meta-icon pin" width="10" height="10"
                                viewBox="0 0 24 24" fill="currentColor" style="margin-right: 4px; opacity: 0.6;">
                                <path d="M5 17h14v-2c0-3.3-2.7-6-6-6V3.5h-4V9c-3.3 0-6 2.7-6 6v2z"></path>
                            </svg>
                            <svg *ngIf="message.isStarred" class="meta-icon star" width="10" height="10"
                                viewBox="0 0 24 24" fill="currentColor"
                                style="margin-right: 4px; opacity: 0.6; color: #ffbc00;">
                                <polygon
                                    points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2">
                                </polygon>
                            </svg>
                            <span class="message-time">{{ formatTime(message.createdAt) }}</span>
                            <span *ngIf="message.sender._id === currentUser?._id && !message.uploadProgress"
                                class="message-status">
                                <span *ngIf="message.seen" class="tick seen">âœ“âœ“</span>
                                <span *ngIf="!message.seen && message.delivered" class="tick delivered">âœ“âœ“</span>
                                <span *ngIf="!message.seen && !message.delivered" class="tick">âœ“</span>
                            </span>
                        </div>

                        <!-- Reactions Display -->
                        <div class="message-reactions" *ngIf="message.reactions && message.reactions.length > 0">
                            <span class="reaction-item">{{ message.reactions[0].emoji }}</span>
                            <span class="reaction-count" *ngIf="message.reactions.length > 1">{{
                                message.reactions.length }}</span>
                        </div>

                        <!-- Upload Progress Overlay -->
                        <div *ngIf="message.uploadProgress !== undefined" class="upload-overlay"
                            style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); border-radius: inherit; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                            <div class="spinner"
                                style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-bottom: 5px;">
                            </div>
                            <span style="color: white; font-size: 0.7em; font-weight: bold;">{{ message.uploadProgress
                                }}%</span>
                        </div>
                    </div>
                </div>
                <div *ngIf="messages.length === 0" class="no-messages"
                    style="text-align:center; color:rgba(255,255,255,0.3); margin-top:40px;">
                    <p>No messages yet</p>
                    <small>Start the conversation!</small>
                </div>
            </div>

            <!-- Selection Mode Action Bar -->
            <div class="selection-action-bar" *ngIf="isSelectMode">
                <div class="selection-info">
                    <button class="cancel-select-btn" (click)="cancelSelectMode()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                    <span class="selected-count">{{ selectedMessages.size }} selected</span>
                </div>
                <div class="selection-actions">
                    <button class="selection-action-btn" (click)="copySelectedMessages()"
                        [disabled]="selectedMessages.size === 0" title="Copy">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>
                    <button class="selection-action-btn" (click)="openForwardModal()"
                        [disabled]="selectedMessages.size === 0" title="Forward">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="15 17 20 12 15 7"></polyline>
                            <path d="M4 18v-2a4 4 0 0 1 4-4h12"></path>
                        </svg>
                    </button>
                    <button class="selection-action-btn delete" (click)="deleteSelectedMessages()"
                        [disabled]="selectedMessages.size === 0" title="Delete">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="message-input-container" *ngIf="!isSelectMode">
                <!-- Reply Bar -->
                <div class="reply-preview-bar" *ngIf="replyingToMessage">
                    <div class="reply-indicator"></div>
                    <div class="reply-content">
                        <div class="reply-sender">{{ replyingToMessage.sender._id === currentUser?._id ? 'You' :
                            replyingToMessage.sender.username }}</div>
                        <div class="reply-text">{{ replyingToMessage.content || 'Media' }}</div>
                    </div>
                    <button class="reply-close" (click)="cancelReply()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <!-- Emoji Picker -->
                <div *ngIf="showEmojiPicker" class="emoji-picker">
                    <span *ngFor="let emoji of emojis" (click)="addEmoji(emoji)">{{ emoji }}</span>
                </div>

                <!-- Attachment Menu -->
                <div class="attachment-menu" *ngIf="showAttachmentMenu">
                    <div class="attachment-option" (click)="selectAttachmentType('document')">
                        <div class="attachment-icon document">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                                <polyline points="13 2 13 9 20 9"></polyline>
                            </svg>
                        </div>
                        <span>Document</span>
                    </div>
                    <div class="attachment-option" (click)="selectAttachmentType('photos')">
                        <div class="attachment-icon photos">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                        </div>
                        <span>Photos & videos</span>
                    </div>
                    <div class="attachment-option" (click)="selectAttachmentType('audio')">
                        <div class="attachment-icon audio">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M9 18V5l12-2v13"></path>
                                <circle cx="6" cy="18" r="3"></circle>
                                <circle cx="18" cy="16" r="3"></circle>
                            </svg>
                        </div>
                        <span>Audio</span>
                    </div>
                    <div class="attachment-option" (click)="selectAttachmentType('poll')">
                        <div class="attachment-icon poll">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <line x1="18" y1="20" x2="18" y2="10"></line>
                                <line x1="12" y1="20" x2="12" y2="4"></line>
                                <line x1="6" y1="20" x2="6" y2="14"></line>
                            </svg>
                        </div>
                        <span>Poll</span>
                    </div>
                </div>

                <div class="input-wrapper">
                    <button class="action-btn" (click)="toggleAttachmentMenu()" title="Attach File">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" [class.rotated]="showAttachmentMenu">
                            <path d="M12 5v14M5 12h14" />
                        </svg>
                    </button>
                    <!-- Hidden file inputs for different types -->
                    <input type="file" #documentInput style="display: none" (change)="onChatFileSelected($event)"
                        accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar">
                    <input type="file" #photoInput style="display: none" (change)="onChatFileSelected($event)"
                        accept="image/*,video/*">
                    <input type="file" #audioInput style="display: none" (change)="onChatFileSelected($event)"
                        accept="audio/*">
                    <input type="file" #cameraInput style="display: none" (change)="onChatFileSelected($event)"
                        accept="image/*" capture="environment">

                    <!-- Language Selector Popup -->
                    <div class="language-selector-popup animate-scale-in" *ngIf="showLanguageSelector">
                        <div class="lang-header">
                            <span>Select Language</span>
                            <button class="close-lang-btn" (click)="showLanguageSelector = false">Ã—</button>
                        </div>
                        <div class="lang-grid">
                            <div class="lang-option" *ngFor="let lang of supportedLanguages"
                                [class.active-lang]="targetLanguage === lang.code"
                                (click)="setTargetLanguage(lang.code)">
                                {{ lang.name }}
                            </div>
                        </div>
                    </div>

                    <button class="action-btn" (click)="toggleTranslationMode()" title="Translate Message"
                        [style.color]="isTranslationMode ? '#00a884' : ''" style="margin-right: 5px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M5 8l6 6"></path>
                            <path d="M4 14h6"></path>
                            <path d="M2 5h12"></path>
                            <path d="M7 2v3"></path>
                            <path d="M22 22l-5-10-5 10"></path>
                            <path d="M14 18h6"></path>
                        </svg>
                    </button>

                    <!-- Live Translation Preview -->
                    <div class="translation-preview-bar animate-scale-in"
                        *ngIf="isTranslationMode && newMessage.trim()">
                        <div class="preview-content">
                            <span class="preview-label">Translation Preview:</span>
                            <span class="preview-text" *ngIf="!isPreviewLoading; else loadingPreview">{{
                                liveTranslationPreview || '...' }}</span>
                            <ng-template #loadingPreview><span
                                    class="preview-text loading">Translating...</span></ng-template>
                        </div>
                    </div>

                    <button class="action-btn" (click)="toggleEmojiPicker()" title="Emoji">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                            <line x1="9" y1="9" x2="9.01" y2="9"></line>
                            <line x1="15" y1="9" x2="15.01" y2="9"></line>
                        </svg>
                    </button>

                    <input type="text" [placeholder]="translationPlaceholder" [(ngModel)]="newMessage"
                        (keyup.enter)="sendMessage()" (input)="onTyping()" [disabled]="isRecording"
                        [style.border-bottom]="isTranslationMode ? '2px solid #00a884' : 'none'">

                    <!-- Mic / Stop Button -->
                    <button class="action-btn" *ngIf="!newMessage.trim()"
                        (click)="isRecording ? stopRecording() : startRecording()"
                        [title]="isRecording ? 'Stop Recording' : 'Record Audio'"
                        [style.color]="isRecording ? '#ef4444' : ''"
                        [style.animation]="isRecording ? 'pulse 1.5s infinite' : ''">
                        <svg *ngIf="!isRecording" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <line x1="12" y1="19" x2="12" y2="23"></line>
                            <line x1="8" y1="23" x2="16" y2="23"></line>
                        </svg>
                        <svg *ngIf="isRecording" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <rect x="6" y="6" width="12" height="12" rx="2" fill="currentColor"></rect>
                        </svg>
                    </button>

                    <!-- Send Button (only when text present) -->
                    <button class="send-btn" *ngIf="newMessage.trim()" (click)="sendMessage()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                </div>
            </div>
        </ng-container>
    </main>

    <!-- File Preview Modal -->
    <div class="modal-overlay" *ngIf="previewFile">
        <div class="preview-modal animate-scale-in">
            <div class="preview-header">
                <h3>Send Attachment?</h3>
                <button class="close-btn" (click)="cancelPreview()">Ã—</button>
            </div>

            <div class="preview-content">
                <img *ngIf="previewUrl && previewFile?.type?.startsWith('image/')" [src]="previewUrl" alt="Preview">
                <video *ngIf="previewUrl && previewFile?.type?.startsWith('video/')" [src]="previewUrl" controls
                    style="max-width: 100%; max-height: 300px;"></video>
                <div *ngIf="!previewUrl" class="file-icon">
                    <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="1.5">
                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                        <polyline points="13 2 13 9 20 9"></polyline>
                    </svg>
                    <span>{{ previewFile.name }}</span>
                    <small>{{ (previewFile.size / 1024 / 1024).toFixed(2) }} MB</small>
                </div>
            </div>

            <div class="preview-actions">
                <button class="cancel-btn" (click)="cancelPreview()">Cancel</button>
                <button class="confirm-btn" (click)="confirmSendFile()">
                    Send
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>


    <!-- Poll Creation Modal -->
    <div class="modal-overlay" *ngIf="showPollModal">
        <div class="poll-modal animate-scale-in">
            <div class="poll-header">
                <button class="back-btn" (click)="closePollModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
                <h3>Create Poll</h3>
                <button class="send-poll-btn" (click)="sendPoll()" [disabled]="!canSendPoll()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>

            <div class="poll-content">
                <div class="poll-question-section">
                    <label>Question</label>
                    <input type="text" [(ngModel)]="pollQuestion" placeholder="Ask a question" maxlength="200">
                    <span class="char-count">{{ pollQuestion.length }}/200</span>
                </div>

                <div class="poll-options-section">
                    <label>Options</label>
                    <div class="poll-option-item"
                        *ngFor="let option of pollOptions; let i = index; trackBy: trackByIndex">
                        <input type="text" [(ngModel)]="pollOptions[i]" [placeholder]="'Option ' + (i + 1)"
                            maxlength="100">
                        <button class="remove-option-btn" *ngIf="pollOptions.length > 2" (click)="removePollOption(i)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <button class="add-option-btn" *ngIf="pollOptions.length < 10" (click)="addPollOption()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add option
                    </button>
                </div>

                <div class="poll-settings-section">
                    <div class="poll-setting">
                        <span>Allow multiple answers</span>
                        <label class="toggle-switch">
                            <input type="checkbox" [(ngModel)]="pollAllowMultiple">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Settings Modal (Redesigned Centered Premium Version) -->
    <div class="settings-overlay-premium" *ngIf="showSettings" (click)="closeSettings()" @fadeIn>
        <div class="settings-modal-premium" (click)="$event.stopPropagation()" @scaleIn>

            <!-- Left Navigation Sidebar -->
            <div class="settings-nav-sidebar">
                <div class="settings-nav-header">
                    <h2 class="text-gradient">Settings</h2>
                </div>

                <div class="settings-nav-profile" (click)="navigateToSettings('profile')"
                    [class.active]="settingsView === 'profile'">
                    <div class="profile-avatar-premium">
                        <img *ngIf="currentUser?.avatar" [src]="getProfileAvatar(currentUser)">
                        <span *ngIf="!currentUser?.avatar">{{ currentUser?.username?.charAt(0)?.toUpperCase() }}</span>
                    </div>
                    <div class="profile-details">
                        <h4>{{ currentUser?.fullName || currentUser?.username }}</h4>
                        <p>My Profile</p>
                    </div>
                </div>

                <div class="settings-nav-items">
                    <div class="nav-item-premium" (click)="navigateToSettings('general')"
                        [class.active]="settingsView === 'general'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="3" y1="9" x2="21" y2="9"></line>
                        </svg>
                        <span>General</span>
                    </div>
                    <div class="nav-item-premium" (click)="navigateToSettings('account')"
                        [class.active]="settingsView === 'account' || settingsView === 'security' || settingsView === 'request-info'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <span>Account</span>
                    </div>
                    <div class="nav-item-premium" (click)="navigateToSettings('privacy')"
                        [class.active]="settingsView === 'privacy' || settingsView === 'app-lock'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        <span>Privacy</span>
                    </div>
                    <div class="nav-item-premium" (click)="navigateToSettings('chats')"
                        [class.active]="settingsView === 'chats' || settingsView === 'media-quality' || settingsView === 'media-auto-download'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <span>Chats</span>
                    </div>
                    <div class="nav-item-premium" (click)="navigateToSettings('notifications')"
                        [class.active]="settingsView === 'notifications'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <span>Notifications</span>
                    </div>
                    <div class="nav-item-premium" (click)="navigateToSettings('video-voice')"
                        [class.active]="settingsView === 'video-voice'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="23 7 16 12 23 17 23 7"></polygon>
                            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                        </svg>
                        <span>Video & Voice</span>
                    </div>
                </div>

                <div class="settings-nav-footer">
                    <button class="logout-btn-premium" (click)="onLogout()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        <span>Log out</span>
                    </button>
                </div>
            </div>

            <!-- Right Content Area -->
            <div class="settings-main-content">
                <button class="settings-close-x" (click)="closeSettings()">Ã—</button>

                <div class="view-container" [ngSwitch]="settingsView">

                    <!-- MAIN WELCOME VIEW -->
                    <div *ngSwitchCase="'main'" class="welcome-view animate-fade-in">
                        <div class="welcome-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                            </svg>
                        </div>
                        <h2>Secure & Personal</h2>
                        <p>Customize your experience, manage your account, and keep your conversations private.</p>
                        <div class="quick-links">
                            <div class="quick-link-card" (click)="navigateToSettings('privacy')">
                                <h4>Privacy Checkup</h4>
                                <p>Review your security settings</p>
                            </div>
                            <div class="quick-link-card" (click)="navigateToSettings('chats')">
                                <h4>Personalize</h4>
                                <p>Change theme and wallpaper</p>
                            </div>
                        </div>
                    </div>

                    <!-- PROFILE VIEW -->
                    <div *ngSwitchCase="'profile'" class="profile-view-premium animate-fade-in">
                        <div class="settings-view-header">
                            <button class="back-btn-premium" (click)="navigateToSettings('main')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2.5">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>
                            <h2>Profile</h2>
                        </div>

                        <div class="profile-content-scroll">
                            <div class="profile-avatar-section">
                                <div class="profile-avatar-giant-wrapper" (click)="fileInput.click()">
                                    <div *ngIf="!currentUser?.avatar" class="giant-avatar">
                                        {{ currentUser?.username?.charAt(0)?.toUpperCase() }}
                                    </div>
                                    <img *ngIf="currentUser?.avatar" [src]="getProfileAvatar(currentUser)"
                                        class="giant-avatar-img">
                                    <div class="edit-overlay-giant">
                                        <svg viewBox="0 0 24 24" width="32" height="32" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <path
                                                d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z">
                                            </path>
                                            <circle cx="12" cy="13" r="4"></circle>
                                        </svg>
                                    </div>
                                </div>
                                <input type="file" #fileInput hidden accept="image/*"
                                    (change)="onProfilePhotoSelected($event)">
                            </div>

                            <div class="profile-info-grid">
                                <div class="profile-card">
                                    <label>Display Name</label>
                                    <div class="editable-field" *ngIf="!isEditingName">
                                        <span>{{ currentUser?.fullName || currentUser?.username }}</span>
                                        <button class="edit-icon-btn" (click)="startEditName()">
                                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none"
                                                stroke="currentColor" stroke-width="2">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7">
                                                </path>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z">
                                                </path>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="edit-mode" *ngIf="isEditingName">
                                        <input type="text" [(ngModel)]="tempProfileName" (keyup.enter)="saveName()"
                                            (keyup.escape)="cancelEditName()" maxlength="100" autofocus>
                                        <div class="edit-btns">
                                            <button class="check-btn" (click)="saveName()">âœ“</button>
                                            <button class="x-btn" (click)="cancelEditName()">âœ•</button>
                                        </div>
                                    </div>
                                    <p class="field-hint">This name will be visible to your contacts.</p>
                                </div>

                                <div class="profile-card">
                                    <label>About</label>
                                    <div class="editable-field" *ngIf="!isEditingAbout">
                                        <span>{{ currentUser?.about || 'Busy doing nothing...' }}</span>
                                        <button class="edit-icon-btn" (click)="startEditAbout()">
                                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none"
                                                stroke="currentColor" stroke-width="2">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7">
                                                </path>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z">
                                                </path>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="edit-mode" *ngIf="isEditingAbout">
                                        <textarea rows="3" [(ngModel)]="tempProfileAbout"
                                            (keyup.escape)="cancelEditAbout()" maxlength="1500" autofocus></textarea>
                                        <div class="edit-btns vertical">
                                            <button class="check-btn" (click)="saveAbout()">âœ“</button>
                                            <button class="x-btn" (click)="cancelEditAbout()">âœ•</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- CHATS VIEW -->
                    <div *ngSwitchCase="'chats'" class="chats-view-premium animate-fade-in">
                        <div class="settings-view-header">
                            <button class="back-btn-premium" (click)="navigateToSettings('main')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2.5">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>
                            <h2>Chats</h2>
                        </div>

                        <div class="settings-content-premium">
                            <div class="settings-card-premium">
                                <h3>Display</h3>
                                <div class="setting-item-premium" (click)="openThemeModal()">
                                    <div class="setting-item-info">
                                        <h4>Theme</h4>
                                        <p>{{ chatSettings.theme }}</p>
                                    </div>
                                    <svg class="chevron-right" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </div>
                                <div class="setting-item-premium" (click)="openWallpaperModal()">
                                    <div class="setting-item-info">
                                        <h4>Wallpaper</h4>
                                        <p>Personalize your chat background</p>
                                    </div>
                                    <svg class="chevron-right" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </div>
                            </div>

                            <div class="settings-card-premium">
                                <h3>Media Settings</h3>
                                <div class="setting-item-premium" (click)="navigateToSettings('media-quality')">
                                    <div class="setting-item-info">
                                        <h4>Media upload quality</h4>
                                        <p>{{ chatSettings.mediaQuality }} quality</p>
                                    </div>
                                    <svg class="chevron-right" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </div>
                                <div class="setting-item-premium" (click)="navigateToSettings('media-auto-download')">
                                    <div class="setting-item-info">
                                        <h4>Media auto-download</h4>
                                        <p>Manage automatic media downloads</p>
                                    </div>
                                    <svg class="chevron-right" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </div>
                            </div>

                            <div class="settings-card-premium">
                                <h3>Typing</h3>
                                <div class="setting-item-premium no-click">
                                    <div class="setting-item-info">
                                        <h4>Spell check</h4>
                                        <p>Check spelling while typing</p>
                                    </div>
                                    <label class="premium-switch">
                                        <input type="checkbox" [(ngModel)]="chatSettings.spellCheck"
                                            (change)="saveSettings()">
                                        <span class="premium-slider"></span>
                                    </label>
                                </div>
                                <div class="setting-item-premium no-click">
                                    <div class="setting-item-info">
                                        <h4>Enter is send</h4>
                                        <p>Use enter key to send messages</p>
                                    </div>
                                    <label class="premium-switch">
                                        <input type="checkbox" [(ngModel)]="chatSettings.enterIsSend"
                                            (change)="saveSettings()">
                                        <span class="premium-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- MEDIA QUALITY VIEW -->
                    <div *ngSwitchCase="'media-quality'" class="sub-view-premium animate-fade-in">
                        <div class="settings-view-header">
                            <button class="back-btn-premium" (click)="navigateToSettings('chats')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2.5">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>
                            <h2>Media upload quality</h2>
                        </div>
                        <div class="settings-content-premium">
                            <p class="section-desc">HD media is clearer, but can use more space and take longer to send.
                            </p>
                            <div class="radio-group-premium">
                                <div class="radio-item-premium"
                                    [class.active]="chatSettings.mediaQuality === 'Standard'"
                                    (click)="chatSettings.mediaQuality = 'Standard'; saveSettings()">
                                    <div class="radio-info">
                                        <h4>Standard quality</h4>
                                        <p>Faster to send, uses less storage</p>
                                    </div>
                                    <div class="radio-check" *ngIf="chatSettings.mediaQuality === 'Standard'">âœ“</div>
                                </div>
                                <div class="radio-item-premium" [class.active]="chatSettings.mediaQuality === 'HD'"
                                    (click)="chatSettings.mediaQuality = 'HD'; saveSettings()">
                                    <div class="radio-info">
                                        <h4>HD quality</h4>
                                        <p>Clearer images and videos</p>
                                    </div>
                                    <div class="radio-check" *ngIf="chatSettings.mediaQuality === 'HD'">âœ“</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- MEDIA AUTO-DOWNLOAD VIEW -->
                    <div *ngSwitchCase="'media-auto-download'" class="sub-view-premium animate-fade-in">
                        <div class="settings-view-header">
                            <button class="back-btn-premium" (click)="navigateToSettings('chats')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2.5">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>
                            <h2>Media auto-download</h2>
                        </div>
                        <div class="settings-content-premium">
                            <div class="settings-card-premium">
                                <div class="setting-item-premium no-click"
                                    *ngFor="let key of ['photos', 'audio', 'videos', 'documents']">
                                    <div class="setting-item-info">
                                        <h4 style="text-transform: capitalize;">{{ key }}</h4>
                                    </div>
                                    <label class="premium-switch">
                                        <input type="checkbox" [(ngModel)]="chatSettings.autoDownload[key]"
                                            (change)="saveSettings()">
                                        <span class="premium-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <p class="field-hint">Voice messages are always automatically downloaded for the best
                                experience.</p>
                        </div>
                    </div>

                    <!-- GENERAL VIEW -->
                    <div *ngSwitchCase="'general'" class="view-premium animate-fade-in">
                        <div class="settings-view-header">
                            <button class="back-btn-premium" (click)="navigateToSettings('main')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2.5">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>
                            <h2>General</h2>
                        </div>
                        <div class="settings-content-premium">
                            <div class="settings-card-premium">
                                <h3>Startup</h3>
                                <div class="setting-item-premium no-click">
                                    <div class="setting-item-info">
                                        <h4>Start at login</h4>
                                        <p>Open the app automatically</p>
                                    </div>
                                    <label class="premium-switch">
                                        <input type="checkbox" [(ngModel)]="generalSettings.startAtLogin">
                                        <span class="premium-slider"></span>
                                    </label>
                                </div>
                                <div class="setting-item-premium no-click">
                                    <div class="setting-item-info">
                                        <h4>Minimize to tray</h4>
                                        <p>Keep app running in background</p>
                                    </div>
                                    <label class="premium-switch">
                                        <input type="checkbox" [(ngModel)]="generalSettings.minimizeToTray">
                                        <span class="premium-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="settings-card-premium">
                                <h3>Appearance</h3>
                                <div class="setting-item-premium" [class.active]="activeNotifDropdown === 'language'"
                                    (click)="toggleNotifDropdown('language', $event)">
                                    <div class="setting-item-info">
                                        <h4>Language</h4>
                                        <p>{{ generalSettings.language }}</p>
                                    </div>
                                    <div class="custom-dropdown-container">
                                        <svg class="chevron-down" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                            stroke-width="2">
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                        </svg>
                                        <div class="premium-dropdown-menu" *ngIf="activeNotifDropdown === 'language'">
                                            <div class="dropdown-item"
                                                (click)="selectGeneralSetting('language', 'English')">English</div>
                                            <div class="dropdown-item"
                                                (click)="selectGeneralSetting('language', 'Hindi')">Hindi</div>
                                            <div class="dropdown-item"
                                                (click)="selectGeneralSetting('language', 'Gujarati')">Gujarati</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PRIVACY VIEW -->
                    <div *ngSwitchCase="'privacy'" class="view-premium animate-fade-in">
                        <div class="settings-view-header">
                            <button class="back-btn-premium" (click)="navigateToSettings('main')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2.5">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>
                            <h2>Privacy</h2>
                        </div>
                        <div class="settings-content-premium">
                            <div class="settings-card-premium">
                                <h3>Visibility</h3>
                                <div class="setting-item-premium" [class.active]="activeNotifDropdown === 'lastSeen'"
                                    (click)="toggleNotifDropdown('lastSeen', $event)">
                                    <div class="setting-item-info">
                                        <h4>Last seen & online</h4>
                                        <p>{{ privacySettings.lastSeen }}</p>
                                    </div>
                                    <div class="custom-dropdown-container">
                                        <svg class="chevron-right" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                            stroke-width="2">
                                            <polyline points="9 18 15 12 9 6"></polyline>
                                        </svg>
                                        <div class="premium-dropdown-menu" *ngIf="activeNotifDropdown === 'lastSeen'">
                                            <div class="dropdown-item"
                                                *ngFor="let option of ['Everyone', 'My contacts', 'Nobody']"
                                                (click)="selectPrivacySetting('lastSeen', option)">{{ option }}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="setting-item-premium"
                                    [class.active]="activeNotifDropdown === 'profilePhoto'"
                                    (click)="toggleNotifDropdown('profilePhoto', $event)">
                                    <div class="setting-item-info">
                                        <h4>Profile photo</h4>
                                        <p>{{ privacySettings.profilePhoto }}</p>
                                    </div>
                                    <div class="custom-dropdown-container">
                                        <svg class="chevron-right" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                            stroke-width="2">
                                            <polyline points="9 18 15 12 9 6"></polyline>
                                        </svg>
                                        <div class="premium-dropdown-menu"
                                            *ngIf="activeNotifDropdown === 'profilePhoto'">
                                            <div class="dropdown-item"
                                                *ngFor="let option of ['Everyone', 'My contacts', 'Nobody']"
                                                (click)="selectPrivacySetting('profilePhoto', option)">{{ option }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="setting-item-premium" [class.active]="activeNotifDropdown === 'about'"
                                    (click)="toggleNotifDropdown('about', $event)">
                                    <div class="setting-item-info">
                                        <h4>About</h4>
                                        <p>{{ privacySettings.about }}</p>
                                    </div>
                                    <div class="custom-dropdown-container">
                                        <svg class="chevron-right" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                            stroke-width="2">
                                            <polyline points="9 18 15 12 9 6"></polyline>
                                        </svg>
                                        <div class="premium-dropdown-menu" *ngIf="activeNotifDropdown === 'about'">
                                            <div class="dropdown-item"
                                                *ngFor="let option of ['Everyone', 'My contacts', 'Nobody']"
                                                (click)="selectPrivacySetting('about', option)">{{ option }}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="setting-item-premium" [class.active]="activeNotifDropdown === 'groups'"
                                    (click)="toggleNotifDropdown('groups', $event)">
                                    <div class="setting-item-info">
                                        <h4>Groups</h4>
                                        <p>{{ privacySettings.groups }}</p>
                                    </div>
                                    <div class="custom-dropdown-container">
                                        <svg class="chevron-right" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                            stroke-width="2">
                                            <polyline points="9 18 15 12 9 6"></polyline>
                                        </svg>
                                        <div class="premium-dropdown-menu" *ngIf="activeNotifDropdown === 'groups'">
                                            <div class="dropdown-item"
                                                *ngFor="let option of ['Everyone', 'My contacts', 'My contacts except...']"
                                                (click)="selectPrivacySetting('groups', option)">{{ option }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-card-premium">
                                <h3>Security</h3>
                                <div class="setting-item-premium" (click)="navigateToSettings('app-lock')">
                                    <div class="setting-item-info">
                                        <h4>App lock</h4>
                                        <p>{{ privacySettings.appLock ? 'Enabled' : 'Disabled' }}</p>
                                    </div>
                                    <svg class="chevron-right" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </div>
                                <div class="setting-item-premium no-click">
                                    <div class="setting-item-info">
                                        <h4>Read receipts</h4>
                                        <p>If turned off, you won't send or receive read receipts</p>
                                    </div>
                                    <label class="premium-switch">
                                        <input type="checkbox" [(ngModel)]="privacySettings.readReceipts"
                                            (change)="saveSettings()">
                                        <span class="premium-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- ACCOUNT VIEW -->
                    <div *ngSwitchCase="'account'" class="view-premium animate-fade-in">
                        <div class="settings-view-header">
                            <button class="back-btn-premium" (click)="navigateToSettings('main')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2.5">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>
                            <h2>Account</h2>
                        </div>
                        <div class="settings-content-premium">
                            <div class="settings-card-premium">
                                <div class="setting-item-premium" (click)="navigateToSettings('security')">
                                    <div class="setting-item-icon-box blue"><svg viewBox="0 0 24 24" width="20"
                                            height="20" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                        </svg></div>
                                    <div class="setting-item-info">
                                        <h4>Security notifications</h4>
                                        <p>End-to-end encryption details</p>
                                    </div>
                                    <svg class="chevron-right" viewBox="0 0 24 24" width="20" height="20" fill="none"
                                        stroke="currentColor" stroke-width="2">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </div>
                                <div class="setting-item-premium" (click)="navigateToSettings('request-info')">
                                    <div class="setting-item-icon-box purple"><svg viewBox="0 0 24 24" width="20"
                                            height="20" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                            <line x1="16" y1="13" x2="8" y2="13"></line>
                                            <line x1="16" y1="17" x2="8" y2="17"></line>
                                            <polyline points="10 9 9 9 8 9"></polyline>
                                        </svg></div>
                                    <div class="setting-item-info">
                                        <h4>Request account info</h4>
                                        <p>Request a report of your account info</p>
                                    </div>
                                    <svg class="chevron-right" viewBox="0 0 24 24" width="20" height="20" fill="none"
                                        stroke="currentColor" stroke-width="2">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECURITY VIEW -->
                    <div *ngSwitchCase="'security'" class="sub-view-premium animate-fade-in">
                        <div class="settings-view-header">
                            <button class="back-btn-premium" (click)="navigateToSettings('account')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2.5">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>
                            <h2>Security</h2>
                        </div>
                        <div class="settings-content-premium center">
                            <div class="security-banner">
                                <div class="security-shield-icon">
                                    <svg viewBox="0 0 24 24" width="60" height="60" fill="none" stroke="var(--primary)"
                                        stroke-width="1.5">
                                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                    </svg>
                                </div>
                                <h3>Your privacy is our priority</h3>
                                <p>WhatsApp secures your conversations with end-to-end encryption. This means your
                                    messages, calls, and status updates stay between you and the people you choose.</p>
                            </div>

                            <div class="settings-card-premium">
                                <div class="setting-item-premium no-click">
                                    <div class="setting-item-info">
                                        <h4>Show security notifications</h4>
                                        <p>Get notified when a contact's security code changes</p>
                                    </div>
                                    <label class="premium-switch">
                                        <input type="checkbox" [(ngModel)]="securitySettings.showNotifications">
                                        <span class="premium-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- REQUEST INFO VIEW -->
                    <div *ngSwitchCase="'request-info'" class="sub-view-premium animate-fade-in">
                        <div class="settings-view-header">
                            <button class="back-btn-premium" (click)="navigateToSettings('account')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2.5">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>
                            <h2>Request Account Info</h2>
                        </div>
                        <div class="settings-content-premium">
                            <div class="request-info-card">
                                <div class="card-icon-main">
                                    <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="var(--primary)"
                                        stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                    </svg>
                                </div>
                                <h3>Request Sent</h3>
                                <p>Your report will be ready in about 3 days. You'll have a few weeks to download it
                                    after it's available.</p>
                                <div class="request-status-badge">Processing...</div>
                            </div>
                        </div>
                    </div>

                    <!-- NOTIFICATIONS VIEW -->
                    <div *ngSwitchCase="'notifications'" class="view-premium animate-fade-in">
                        <div class="settings-view-header">
                            <button class="back-btn-premium" (click)="navigateToSettings('main')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2.5">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>
                            <h2>Notifications</h2>
                        </div>
                        <div class="settings-content-premium">
                            <div class="settings-card-premium">
                                <h3>General</h3>
                                <div class="setting-item-premium no-click">
                                    <div class="setting-item-info">
                                        <h4>Message notifications</h4>
                                        <p>Show notifications for new messages</p>
                                    </div>
                                    <label class="premium-switch">
                                        <input type="checkbox" [(ngModel)]="notificationSettings.messageNotifications"
                                            (change)="saveSettings()">
                                        <span class="premium-slider"></span>
                                    </label>
                                </div>
                                <div class="setting-item-premium no-click">
                                    <div class="setting-item-info">
                                        <h4>Show previews</h4>
                                        <p>Preview message text in notifications</p>
                                    </div>
                                    <label class="premium-switch">
                                        <input type="checkbox" [(ngModel)]="notificationSettings.showPreviews"
                                            (change)="saveSettings()">
                                        <span class="premium-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="settings-card-premium">
                                <h3>Sounds</h3>
                                <div class="setting-item-premium" [class.active]="activeNotifDropdown === 'messageTone'"
                                    (click)="toggleNotifDropdown('messageTone', $event)">
                                    <div class="setting-item-info">
                                        <h4>Message tone</h4>
                                        <p>{{ notificationSettings.messageTone }}</p>
                                    </div>
                                    <div class="custom-dropdown-container">
                                        <svg class="chevron-down" viewBox="0 0 24 24" width="20" height="20" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                        </svg>
                                        <div class="premium-dropdown-menu"
                                            *ngIf="activeNotifDropdown === 'messageTone'">
                                            <div class="dropdown-item" *ngFor="let tone of notificationTones"
                                                (click)="selectNotifSetting('messageTone', tone)">{{ tone }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VIDEO & VOICE VIEW -->
                    <div *ngSwitchCase="'video-voice'" class="view-premium animate-fade-in">
                        <div class="settings-view-header">
                            <button class="back-btn-premium" (click)="navigateToSettings('main')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2.5">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>
                            <h2>Video & Voice</h2>
                        </div>
                        <div class="settings-content-premium">
                            <div class="settings-card-premium">
                                <h3>Devices</h3>
                                <div class="setting-item-premium" [class.active]="activeNotifDropdown === 'camera'"
                                    (click)="toggleNotifDropdown('camera', $event)">
                                    <div class="setting-item-info">
                                        <h4>Camera</h4>
                                        <p>{{ videoSettings.cameraDeviceId ? 'Selected' : 'None' }}</p>
                                    </div>
                                    <div class="custom-dropdown-container">
                                        <svg class="chevron-down" viewBox="0 0 24 24" width="18" height="18" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                        </svg>
                                        <div class="premium-dropdown-menu" *ngIf="activeNotifDropdown === 'camera'">
                                            <div class="dropdown-item" *ngFor="let device of videoInputDevices"
                                                (click)="selectVideoSetting('cameraDeviceId', device.deviceId)">
                                                {{ device.label }}
                                            </div>
                                            <div class="dropdown-item" *ngIf="videoInputDevices.length === 0">No cameras
                                                found</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="setting-item-premium" [class.active]="activeNotifDropdown === 'microphone'"
                                    (click)="toggleNotifDropdown('microphone', $event)">
                                    <div class="setting-item-info">
                                        <h4>Microphone</h4>
                                        <p>{{ videoSettings.micDeviceId ? 'Selected' : 'None' }}</p>
                                    </div>
                                    <div class="custom-dropdown-container">
                                        <svg class="chevron-down" viewBox="0 0 24 24" width="18" height="18" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                        </svg>
                                        <div class="premium-dropdown-menu" *ngIf="activeNotifDropdown === 'microphone'">
                                            <div class="dropdown-item" *ngFor="let device of audioInputDevices"
                                                (click)="selectVideoSetting('micDeviceId', device.deviceId)">
                                                {{ device.label }}
                                            </div>
                                            <div class="dropdown-item" *ngIf="audioInputDevices.length === 0">No
                                                microphones found</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="setting-item-premium" [class.active]="activeNotifDropdown === 'speakers'"
                                    (click)="toggleNotifDropdown('speakers', $event)">
                                    <div class="setting-item-info">
                                        <h4>Speakers</h4>
                                        <p>{{ videoSettings.speakerDeviceId ? 'Selected' : 'None' }}</p>
                                    </div>
                                    <div class="custom-dropdown-container">
                                        <svg class="chevron-down" viewBox="0 0 24 24" width="18" height="18" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                        </svg>
                                        <div class="premium-dropdown-menu" *ngIf="activeNotifDropdown === 'speakers'">
                                            <div class="dropdown-item" *ngFor="let device of audioOutputDevices"
                                                (click)="selectVideoSetting('speakerDeviceId', device.deviceId)">
                                                {{ device.label }}
                                            </div>
                                            <div class="dropdown-item" *ngIf="audioOutputDevices.length === 0">No
                                                speakers found</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- APP LOCK VIEW -->
                    <div *ngSwitchCase="'app-lock'" class="view-premium animate-fade-in">
                        <div class="settings-view-header">
                            <button class="back-btn-premium" (click)="navigateToSettings('privacy')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2.5">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>
                            <h2>App Lock</h2>
                        </div>
                        <div class="settings-content-premium center">
                            <div class="lock-setup-banner">
                                <div class="lock-shield-icon">
                                    <svg viewBox="0 0 24 24" width="80" height="80" fill="none" stroke="var(--primary)"
                                        stroke-width="1.5">
                                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                    </svg>
                                </div>
                                <h3>Protect your messages</h3>
                                <p>When enabled, you'll need to enter your password to use WhatsApp. You can still
                                    answer calls even if WhatsApp is locked.</p>
                            </div>

                            <div class="settings-card-premium">
                                <div class="setting-item-premium no-click">
                                    <div class="setting-item-info">
                                        <h4>Enable app lock</h4>
                                        <p>Require password to unlock the app</p>
                                    </div>
                                    <label class="premium-switch">
                                        <input type="checkbox" [(ngModel)]="privacySettings.appLock"
                                            (change)="toggleAppLock($event)">
                                        <span class="premium-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div> <!-- End of App Lock -->
                </div> <!-- End of view-container -->
            </div> <!-- End of settings-main-content -->
        </div> <!-- End of settings-modal-premium -->
    </div> <!-- End of settings-overlay-premium -->

    <div class="modal-overlay" *ngIf="showSetPasswordModal">
        <div class="set-password-modal animate-scale-in">
            <h2>Set password</h2>

            <div class="input-group">
                <label>Enter password</label>
                <input type="password" [(ngModel)]="tempPassword" placeholder="Enter password" class="password-input">
                <div class="input-line"></div>
            </div>

            <div class="input-group">
                <label>Re-enter password</label>
                <input type="password" [(ngModel)]="tempConfirmPassword" placeholder="Re-enter password"
                    class="password-input">
                <div class="input-line"></div>
            </div>

            <p class="password-hint">
                Password must be 6-128 characters, and may only contain letters, numbers, and common punctuation
            </p>

            <div class="modal-actions">
                <button class="cancel-text-btn" (click)="closeSetPasswordModal()">Cancel</button>
                <button class="ok-btn" (click)="confirmSetPassword()">OK</button>
            </div>
        </div>
    </div>

    <!-- Password Set Success Modal -->
    <div class="modal-overlay" *ngIf="showPasswordSetModal">
        <div class="password-set-modal animate-scale-in">
            <h2>Password set</h2>

            <p class="success-text">You can lock WhatsApp from the Chats menu.</p>
            <p class="success-text sub">Update app lock anytime in Settings > Privacy > App lock.</p>

            <div class="modal-actions-spread">
                <button class="done-text-btn" (click)="closePasswordSetModal()">Done</button>
                <button class="lock-now-btn" (click)="lockApp()">Lock now</button>
            </div>
        </div>
    </div>

    <!-- Locked Screen Overlay -->
    <div class="locked-overlay" *ngIf="isAppLocked">
        <div class="locked-content animate-fade-in">
            <div class="locked-avatar">
                <img *ngIf="currentUser?.avatar" [src]="getProfileAvatar(currentUser)" alt="Avatar">
                <div *ngIf="!currentUser?.avatar" class="default-initial">{{
                    currentUser?.username?.charAt(0)?.toUpperCase()
                    }}</div>
            </div>

            <h2 class="locked-username">{{ currentUser?.fullName || currentUser?.username }}</h2>

            <p class="locked-message">App lock is on. Enter your password to use WhatsApp Windows.</p>

            <div class="unlock-input-wrapper">
                <input [type]="isPasswordVisible ? 'text' : 'password'" [(ngModel)]="unlockPasswordInput"
                    placeholder="Enter password" (keyup.enter)="attemptUnlock()">
                <button class="visibility-toggle" (click)="togglePasswordVisibility()">
                    <!-- Eye Icon (Show) -->
                    <svg *ngIf="!isPasswordVisible" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <!-- Eye Slash Icon (Hide) -->
                    <svg *ngIf="isPasswordVisible" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path
                            d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24">
                        </path>
                        <line x1="1" y1="1" x2="23" y2="23"></line>
                    </svg>
                </button>
            </div>
            <div class="input-line active"></div>

            <button class="unlock-btn" (click)="attemptUnlock()">Unlock</button>

            <div class="locked-footer">
                <a class="forgot-link">Forgot password?</a>
                <p class="logout-hint">Log out and link again from your phone.</p>
                <button class="logout-link" (click)="onLogout()">Log out</button>
            </div>
        </div>
    </div><!-- Theme Selection Modal -->
    <div class="modal-overlay" *ngIf="showThemeModal">
        <div class="theme-modal animate-scale-in">
            <h2>Theme</h2>

            <div class="radio-option" (click)="tempTheme = 'Light'">
                <div class="radio-circle">
                    <div class="radio-inner" *ngIf="tempTheme === 'Light'"></div>
                </div>
                <span>Light</span>
            </div>

            <div class="radio-option" (click)="tempTheme = 'Dark'">
                <div class="radio-circle">
                    <div class="radio-inner" *ngIf="tempTheme === 'Dark'"></div>
                </div>
                <span>Dark</span>
            </div>

            <div class="radio-option" (click)="tempTheme = 'System default'">
                <div class="radio-circle">
                    <div class="radio-inner" *ngIf="tempTheme === 'System default'"></div>
                </div>
                <span>System default</span>
            </div>

            <div class="modal-actions">
                <button class="cancel-text-btn" (click)="closeThemeModal()">Cancel</button>
                <button class="ok-btn" (click)="applyTheme()">OK</button>
            </div>
        </div>
    </div>

    <!-- Permission Alert Modal -->
    <div class="modal-overlay" *ngIf="showPermissionModal">
        <div class="theme-modal animate-scale-in" style="max-width: 350px;">
            <h2>Permission Denied</h2>

            <p style="color: var(--text-secondary); margin: 15px 0 25px; line-height: 1.5;">
                {{ permissionMessage }}
            </p>

            <div class="modal-actions">
                <button class="ok-btn" (click)="closePermissionModal()">OK</button>
            </div>
        </div>
    </div>


    <!-- Wallpaper Modal -->
    <div class="wallpaper-modal-overlay" *ngIf="showWallpaperModal" (click)="closeWallpaperModal()">
        <div class="wallpaper-modal animate-scale-in" (click)="$event.stopPropagation()">
            <div class="wallpaper-header">
                <button class="back-btn" (click)="closeWallpaperModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    Set chat wallpaper
                </button>
            </div>

            <div class="preview-container">
                <div class="mini-preview" [style.background-color]="tempWallpaper.color"
                    [style.background-image]="tempWallpaper.image ? 'url(' + tempWallpaper.image + ')' : null"
                    [class.has-doodles]="tempWallpaper.doodles && !tempWallpaper.image">
                    <!-- Mock Message Bubble -->
                    <div class="mock-bubble received">Hello there!</div>
                    <div class="mock-bubble sent">Wallpaper preview âœ¨</div>
                </div>
            </div>

            <div class="wallpaper-content">
                <div class="doodle-option">
                    <label class="checkbox-container">
                        <input type="checkbox" [(ngModel)]="tempWallpaper.doodles">
                        <span class="checkmark"></span>
                        Add WhatsApp doodles
                    </label>
                </div>

                <div class="wallpaper-section-title">Solid Colors</div>
                <div class="wallpaper-grid">
                    <!-- Hidden File Input -->
                    <input type="file" accept="image/*" #fileInput (change)="onWallpaperFileSelected($event)"
                        style="display: none">

                    <!-- Upload Button Tile -->
                    <div class="wallpaper-item upload-item" (click)="fileInput.click()">
                        <div class="upload-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                        </div>
                    </div>

                    <div class="wallpaper-item" *ngFor="let color of wallpaperColors" [style.background-color]="color"
                        [class.selected]="tempWallpaper.color === color" (click)="selectWallpaperColor(color)">
                    </div>
                </div>
            </div>

            <div class="wallpaper-actions">
                <label class="checkbox-container footer-doodle-checkbox">
                    <input type="checkbox" [(ngModel)]="tempWallpaper.doodles">
                    <span class="checkmark"></span>
                    Add Doodles
                </label>
                <div style="flex: 1"></div> <!-- Spacer -->
                <button class="cancel-btn" (click)="closeWallpaperModal()">Cancel</button>
                <button class="confirm-btn" (click)="saveWallpaper()">Set Wallpaper</button>
            </div>
        </div>
    </div>
</div>

<!-- Forward Modal -->
<div class="modal-overlay" *ngIf="showForwardModal" (click)="closeForwardModal()">
    <div class="forward-modal animate-scale-in" (click)="$event.stopPropagation()">
        <div class="forward-header">
            <h3>Forward to</h3>
            <button class="close-btn" (click)="closeForwardModal()">Ã—</button>
        </div>

        <div class="forward-search">
            <input type="text" [(ngModel)]="forwardSearchQuery" placeholder="Search contacts">
        </div>

        <div class="forward-users-list">
            <div *ngFor="let user of filteredForwardUsers" class="forward-user-item" (click)="forwardToUser(user)">
                <div class="user-avatar">
                    <img *ngIf="user.avatar" [src]="getAvatarUrl(user.avatar)" alt="Avatar">
                    <span *ngIf="!user.avatar">{{ (user?.username || '').charAt(0).toUpperCase() }}</span>
                </div>
                <div class="user-details">
                    <div class="user-name">{{ user?.fullName || user?.username }}</div>
                    <div class="user-status">{{ user?.isOnline ? 'Online' : 'Offline' }}</div>
                </div>
                <button class="forward-send-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
            <div *ngIf="filteredForwardUsers.length === 0" class="no-results">
                No contacts found
            </div>
        </div>
    </div>
</div>

<!-- New Group Modal -->
<div class="modal-overlay" *ngIf="showNewGroupModal" (click)="closeNewGroupModal()">
    <div class="group-modal animate-scale-in" (click)="$event.stopPropagation()">
        <!-- Step 1: Select Participants -->
        <ng-container *ngIf="newGroupStep === 1">
            <div class="group-header">
                <button class="modal-back-btn" (click)="closeNewGroupModal()">âœ•</button>
                <div class="header-text">
                    <h3>Add group participants</h3>
                    <span class="sub-text">{{ selectedParticipants.size }} selected</span>
                </div>
                <button class="next-step-btn" (click)="nextGroupStep()" [disabled]="selectedParticipants.size === 0">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>

            <div class="group-search">
                <div class="selected-tags" *ngIf="selectedParticipants.size > 0">
                    <div class="participant-tag" *ngFor="let userId of selectedParticipants">
                        <ng-container *ngFor="let user of users">
                            <span *ngIf="user._id === userId">{{ user.username }}</span>
                        </ng-container>
                        <button class="remove-tag" (click)="toggleParticipant(userId)">âœ•</button>
                    </div>
                </div>
                <input type="text" [(ngModel)]="groupSearchQuery" placeholder="Type contact name">
            </div>

            <div class="group-users-list">
                <div *ngFor="let user of filteredGroupUsers" class="group-user-item"
                    [class.selected]="selectedParticipants.has(user._id)" (click)="toggleParticipant(user._id)">
                    <div class="user-avatar">
                        <img *ngIf="user.avatar" [src]="getAvatarUrl(user.avatar)" (error)="handleImageError($event)"
                            alt="Avatar">
                        <span class="avatar-fallback" [style.display]="user.avatar ? 'none' : 'flex'">{{
                            (user?.username
                            || '').charAt(0).toUpperCase() }}</span>
                    </div>
                    <div class="user-details">
                        <div class="user-name">{{ user?.fullName || user?.username }}</div>
                        <div class="user-status">{{ user?.isOnline ? 'Online' : 'Offline' }}</div>
                    </div>
                    <div class="custom-checkbox" [class.checked]="selectedParticipants.has(user._id)">
                        <svg *ngIf="selectedParticipants.has(user._id)" width="14" height="14" viewBox="0 0 24 24"
                            fill="none" stroke="white" stroke-width="4">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                </div>
                <div *ngIf="filteredGroupUsers.length === 0" class="no-results">
                    No contacts found
                </div>
            </div>
        </ng-container>

        <!-- Step 2: Group Details -->
        <ng-container *ngIf="newGroupStep === 2">
            <div class="group-header">
                <button class="modal-back-btn" (click)="newGroupStep = 1">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                <div class="header-text">
                    <h3>New group</h3>
                </div>
                <button class="create-group-btn" (click)="createGroup()" [disabled]="!newGroupName.trim()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </button>
            </div>

            <div class="group-setup-content">
                <input type="file" #groupIconInput style="display: none" (change)="onGroupIconSelected($event)"
                    accept="image/*">

                <div class="group-icon-setup" (click)="groupIconInput.click()">
                    <div class="group-icon-placeholder">
                        <img *ngIf="newGroupIconPreview" [src]="newGroupIconPreview"
                            style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        <svg *ngIf="!newGroupIconPreview" width="40" height="40" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="1.5">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z">
                            </path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                    </div>
                    <span>{{ newGroupIconPreview ? 'Change group icon' : 'Add group icon' }}</span>
                </div>

                <div class="group-name-input">
                    <input type="text" [(ngModel)]="newGroupName" placeholder="Group Subject" maxlength="25">
                    <span class="char-countdown">{{ 25 - newGroupName.length }}</span>
                </div>

                <div class="participants-summary">
                    <label>Participants: {{ selectedParticipants.size }}</label>
                    <div class="participants-grid">
                        <div class="participant-thumb" *ngFor="let userId of selectedParticipants">
                            <ng-container *ngFor="let user of users">
                                <div *ngIf="user._id === userId" class="thumb-container">
                                    <div class="avatar-sm">
                                        <img *ngIf="user.avatar" [src]="getAvatarUrl(user.avatar)">
                                        <span *ngIf="!user.avatar">{{ user?.username?.charAt(0)?.toUpperCase()
                                            }}</span>
                                    </div>
                                    <span class="name-sm">{{ user.username }}</span>
                                </div>
                            </ng-container>
                        </div>
                    </div>
                </div>
            </div>
        </ng-container>
    </div>
</div>

<!-- Group Info Modal -->
<div class="modal-overlay sidebar-overlay" *ngIf="showGroupInfo" (click)="closeGroupInfo()">
    <div class="sidebar-panel animate-slide-in-right" (click)="$event.stopPropagation()">
        <div class="group-info-header">
            <button class="close-btn" (click)="closeGroupInfo()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5"></path>
                    <path d="M12 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div class="header-titles">
                <h3>Group info</h3>
                <span class="sub-text">{{ (selectedUser?.participants?.length || 0) + 1 }} participants</span>
            </div>
            <button class="search-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </button>
        </div>

        <div class="group-info-content">
            <div class="group-info-main">
                <div class="group-large-avatar">
                    <img *ngIf="selectedUser?.avatar"
                        [src]="(selectedUser?.avatar?.startsWith('data:')) ? selectedUser?.avatar : getAvatarUrl(selectedUser?.avatar)">
                    <svg *ngIf="!selectedUser?.avatar" width="60" height="60" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="1.5">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
                <h2>{{ selectedUser?.fullName || selectedUser?.username }}</h2>
                <span class="group-status-text">Group â€¢ {{ (selectedUser?.participants?.length || 0) + 1 }}
                    participants</span>
            </div>

            <div class="group-info-section">
                <div class="participant-actions">
                    <div class="action-item" (click)="openAddMembersModal()">
                        <div class="action-icon green">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <line x1="19" y1="8" x2="19" y2="14"></line>
                                <line x1="22" y1="11" x2="16" y2="11"></line>
                            </svg>
                        </div>
                        <div class="action-text">Add members</div>
                    </div>
                    <div class="action-item" (click)="openInviteModal()">
                        <div class="action-icon green">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                            </svg>
                        </div>
                        <div class="action-text">Invite via link or QR code</div>
                    </div>
                    <div class="action-item">
                        <div class="action-icon green">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </div>
                        <div class="action-text">Add members to contacts</div>
                    </div>
                </div>

                <div class="participants-list">
                    <!-- You (current user) -->
                    <div class="participant-item">
                        <div class="user-avatar">
                            <img *ngIf="currentUser?.avatar" [src]="getAvatarUrl(currentUser?.avatar)"
                                (error)="handleImageError($event)">
                            <span class="avatar-fallback" [style.display]="currentUser?.avatar ? 'none' : 'flex'">{{
                                (currentUser?.username || '').charAt(0).toUpperCase() }}</span>
                        </div>
                        <div class="user-details">
                            <div class="user-name-row">
                                <span class="user-name">You</span>
                                <span class="admin-badge">Group Admin</span>
                            </div>
                            <div class="user-bio">Add member tag</div>
                        </div>
                    </div>

                    <!-- Other members -->
                    <div *ngFor="let userId of selectedUser?.participants" class="participant-item">
                        <ng-container *ngIf="getParticipantInfo(userId) as user">
                            <div class="user-avatar">
                                <img *ngIf="user.avatar" [src]="getAvatarUrl(user.avatar)"
                                    (error)="handleImageError($event)">
                                <span class="avatar-fallback" [style.display]="user.avatar ? 'none' : 'flex'">{{
                                    (user?.username || '').charAt(0).toUpperCase() }}</span>
                            </div>
                            <div class="user-details">
                                <div class="user-name">{{ user?.fullName || user?.username }}</div>
                                <div class="user-bio">{{ user?.about || 'Hey there! I am using WhatsApp.' }}
                                </div>
                            </div>
                        </ng-container>
                    </div>
                </div>
            </div>

            <div class="group-info-actions">
                <button class="exit-action-btn" (click)="exitGroup()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    <span>Exit group</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Exit Group Confirmation Modal -->
<div class="modal-overlay" *ngIf="showExitGroupConfirm" (click)="closeExitGroupConfirm()">
    <div class="theme-modal animate-scale-in" style="max-width: 350px;">
        <h2>Exit Group?</h2>
        <p style="color: var(--text-secondary); margin: 15px 0 25px; line-height: 1.5;">
            Are you sure you want to exit "{{ selectedUser?.fullName || selectedUser?.username }}" group?
        </p>
        <div class="modal-actions" style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="cancel-btn-outline" (click)="closeExitGroupConfirm()"
                style="background: none; border: 1px solid var(--border-subtle); color: var(--text-main); padding: 8px 20px; border-radius: 8px; cursor: pointer;">Cancel</button>
            <button class="ok-btn" (click)="confirmExitGroup()" style="background: #f15c6d; color: white;">Exit</button>
        </div>
    </div>
</div>

<!-- Add Members Modal -->
<div class="modal-overlay" *ngIf="showAddMembersModal" (click)="closeAddMembersModal()">
    <div class="theme-modal animate-scale-in"
        style="max-width: 450px; height: 80vh; display: flex; flex-direction: column;"
        (click)="$event.stopPropagation()">
        <div class="modal-header" style="padding-bottom: 20px; border-bottom: 1px solid var(--border-subtle);">
            <h2 style="margin: 0;">Add Members</h2>
            <button class="close-btn" (click)="closeAddMembersModal()">Ã—</button>
        </div>

        <div style="flex: 1; overflow-y: auto; padding: 20px 0;">
            <div *ngFor="let user of getUsersNotInGroup()" class="user-selection-item"
                [class.selected]="selectedParticipants.has(user._id)" (click)="toggleParticipant(user._id)"
                style="display: flex; align-items: center; gap: 15px; padding: 12px 20px; cursor: pointer; transition: background 0.2s;">
                <div class="user-avatar"
                    style="width: 45px; height: 45px; border-radius: 50%; background: var(--glass-light); display: flex; align-items: center; justify-content: center; overflow: hidden; color: var(--text-main);">
                    <img *ngIf="user.avatar" [src]="getAvatarUrl(user.avatar)" (error)="handleImageError($event)"
                        style="width: 100%; height: 100%; object-fit: cover;">
                    <span class="avatar-fallback" [style.display]="user.avatar ? 'none' : 'flex'">{{
                        (user?.username ||
                        '').charAt(0).toUpperCase() }}</span>
                </div>
                <div style="flex: 1;">
                    <div style="color: var(--text-main); font-weight: 500;">{{ user.fullName || user.username }}
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.85rem;">{{ user.about || 'Available' }}
                    </div>
                </div>
                <div class="custom-checkbox" [class.checked]="selectedParticipants.has(user._id)"
                    style="width: 20px; height: 20px; border: 2px solid var(--border-subtle); border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                    <svg *ngIf="selectedParticipants.has(user._id)" width="12" height="12" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
            </div>
            <div *ngIf="getUsersNotInGroup().length === 0"
                style="text-align: center; padding: 40px; color: var(--text-muted);">
                All contacts are already in this group.
            </div>
        </div>

        <div class="modal-footer"
            style="padding-top: 20px; border-top: 1px solid var(--border-subtle); display: flex; justify-content: flex-end; gap: 10px;">
            <button class="cancel-btn-outline" (click)="closeAddMembersModal()"
                style="background: none; border: 1px solid var(--border-subtle); color: var(--text-main); padding: 10px 25px; border-radius: 8px; cursor: pointer;">Cancel</button>
            <button class="ok-btn" (click)="confirmAddMembers()" [disabled]="selectedParticipants.size === 0">Add
                Members ({{ selectedParticipants.size }})</button>
        </div>
    </div>
</div>

<!-- Group Invite Modal -->
<div class="modal-overlay" *ngIf="showInviteModal" (click)="closeInviteModal()">
    <div class="theme-modal animate-scale-in" style="max-width: 400px; text-align: center;"
        (click)="$event.stopPropagation()">
        <h2 style="margin-bottom: 20px;">Invite to Group</h2>
        <p style="color: var(--text-muted); margin-bottom: 25px;">Share this link to invite participants:</p>

        <!-- QR Code -->
        <div style="background: white; padding: 15px; border-radius: 12px; display: inline-block; margin-bottom: 25px;">
            <img [src]="'https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=' + groupInviteLink"
                alt="Group Invite QR Code" style="width: 150px; height: 150px;">
        </div>

        <div
            style="background: var(--glass-light); padding: 15px; border-radius: 10px; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; border: 1px dashed var(--border-subtle);">
            <span
                style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-family: monospace; font-size: 0.9rem; color: var(--text-main);">{{
                groupInviteLink }}</span>
            <button (click)="copyInviteLink()"
                style="background: var(--accent-primary); border: none; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">Copy</button>
        </div>

        <button class="ok-btn" (click)="closeInviteModal()" style="width: 100%;">Done</button>
    </div>
</div>

<!-- Message Context Menu -->
<div class="msg-context-menu" *ngIf="showContextMenu" [style.left.px]="contextMenuPosition.x"
    [style.top.px]="contextMenuPosition.y" (click)="$event.stopPropagation()">

    <!-- Emoji Reactions Row -->
    <div class="reactions-row">
        <button *ngFor="let emoji of reactionEmojis" (click)="reactToMessage(emoji, contextMenuMessage!)"
            class="reaction-btn">
            {{ emoji }}
        </button>
        <button class="reaction-btn more-btn" (click)="toggleEmojiPicker(); closeContextMenu()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        </button>
    </div>

    <div class="menu-divider"></div>

    <div class="menu-item" (click)="viewMessageInfo(contextMenuMessage!)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <span>Message info</span>
    </div>

    <div class="menu-item" (click)="setReply(contextMenuMessage!)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 17 4 12 9 7"></polyline>
            <path d="M20 18v-2a4 4 0 0 0-4-4H4"></path>
        </svg>
        <span>Reply</span>
    </div>

    <div class="menu-item" (click)="copyMessageText(contextMenuMessage!)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
        <span>Copy</span>
    </div>

    <div class="menu-item" (click)="forwardMessage(contextMenuMessage!)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 17 20 12 15 7"></polyline>
            <path d="M4 18v-2a4 4 0 0 1 4-4h12"></path>
        </svg>
        <span>Forward</span>
    </div>

    <div class="menu-divider"></div>

    <!-- Translation Removed from Context Menu -->

    <div class="menu-item" (click)="starMessage(contextMenuMessage!)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon
                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2">
            </polygon>
        </svg>
        <span>{{ contextMenuMessage?.isStarred ? 'Unstar' : 'Star' }}</span>
    </div>

    <div class="menu-item" (click)="pinMessage(contextMenuMessage!)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="17" x2="12" y2="22"></line>
            <path d="M5 17h14v-2c0-3.3-2.7-6-6-6V3.5h-4V9c-3.3 0-6 2.7-6 6v2z"></path>
        </svg>
        <span>{{ contextMenuMessage?.isPinned ? 'Unpin' : 'Pin' }}</span>
    </div>

    <div class="menu-divider"></div>

    <div class="menu-item" (click)="enableSelectMode()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <polyline points="9 11 12 14 22 4"></polyline>
        </svg>
        <span>Select</span>
    </div>

    <div class="menu-divider"></div>

    <div class="menu-item delete-item" (click)="deleteMessage(contextMenuMessage!)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
        <span>Delete</span>
    </div>
</div>

<!-- Full Emoji Picker Modal (for reactions) -->
<div class="modal-overlay emoji-picker-overlay" *ngIf="showEmojiPicker && emojiPickerMessage"
    (click)="closeEmojiPickerModal()">
    <div class="emoji-picker-modal animate-scale-in" (click)="$event.stopPropagation()">
        <div class="emoji-picker-header">
            <h3>Select Emoji</h3>
            <button class="close-btn" (click)="closeEmojiPickerModal()">Ã—</button>
        </div>
        <div class="emoji-picker-content">
            <div class="emoji-grid">
                <button *ngFor="let emoji of emojis" class="emoji-btn" (click)="selectEmojiForReaction(emoji)">
                    {{ emoji }}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Custom Confirm Modal -->
<div class="modal-overlay" *ngIf="showConfirmModal" (click)="closeConfirmModal()">
    <div class="theme-modal animate-scale-in confirm-modal" (click)="$event.stopPropagation()">
        <h2 class="modal-title">{{ confirmTitle }}</h2>
        <p class="modal-message">{{ confirmMessage }}</p>
        <div class="modal-actions">
            <button class="cancel-btn-outline" (click)="closeConfirmModal()">Cancel</button>
            <button class="ok-btn delete-btn" (click)="executeConfirmAction()">Delete</button>
        </div>
    </div>
</div>

<!-- Message Info Modal -->
<div class="modal-overlay" *ngIf="showMessageInfoModal" (click)="closeMessageInfoModal()">
    <div class="theme-modal animate-scale-in info-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2 style="margin: 0;">Message Info</h2>
            <button class="close-btn" (click)="closeMessageInfoModal()">Ã—</button>
        </div>
        <div class="info-body" *ngIf="selectedMessageInfo">
            <div class="info-row">
                <span class="label">Sent:</span>
                <span class="value">{{ selectedMessageInfo.createdAt | date:"MMM d, y, h:mm a" }}</span>
            </div>
            <div class="info-row">
                <span class="label">Status:</span>
                <span class="value status" [class.read]="selectedMessageInfo.seen">
                    {{ selectedMessageInfo.seen ? "Read" : (selectedMessageInfo.delivered ? "Delivered" :
                    "Sent") }}
                </span>
            </div>
            <div class="info-row" *ngIf="selectedMessageInfo.seenAt">
                <span class="label">Read at:</span>
                <span class="value">{{ selectedMessageInfo.seenAt | date:"MMM d, y, h:mm a" }}</span>
            </div>
            <div class="info-row">
                <span class="label">Message Type:</span>
                <span class="value" style="text-transform: capitalize;">{{ selectedMessageInfo.messageType
                    }}</span>
            </div>
        </div>
        <div class="modal-footer">
            <button class="ok-btn" (click)="closeMessageInfoModal()" style="width: 100%;">Close</button>
        </div>
    </div>
</div>

<!-- Link Device Modal -->
<div class="modal-overlay" *ngIf="showLinkDeviceModal">
    <div class="theme-modal animate-scale-in"
        style="max-width: 350px; padding: 0; background: #202c33; color: #e9edef;">
        <div class="modal-header"
            style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; font-size:1.2rem;">Link with Mobile</h3>
            <button class="close-btn" (click)="closeLinkDeviceModal()"
                style="background:none; border:none; color:inherit; font-size:1.5rem; cursor:pointer;">Ã—</button>
        </div>
        <div class="modal-body"
            style="padding: 30px; display: flex; flex-direction: column; align-items: center; text-align: center;">
            <p style="margin-bottom: 20px; color: #8696a0;">Scan this code with your mobile camera to log in
                instantly.
            </p>

            <div class="qr-container"
                style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                <div *ngIf="qrLoading" class="spinner"
                    style="width:40px; height:40px; border:3px solid #eee; border-top-color:#00a884; border-radius:50%; animation:spin 1s linear infinite;">
                </div>
                <img *ngIf="qrCodeDataUrl && !qrLoading" [src]="qrCodeDataUrl"
                    style="width: 240px; height: 240px; display: block;">
            </div>

            <p *ngIf="qrCodeDataUrl" style="font-size: 0.9em; color: #8696a0;">
                Code expires in a few minutes. <br>
                <a href="javascript:void(0)" (click)="generateLinkQr()"
                    style="color: #00a884; text-decoration: none; font-weight:500;">Refresh code</a>
            </p>
        </div>
    </div>
</div>

<!-- Contact Info Modal -->
<div class="modal-overlay sidebar-overlay" *ngIf="showContactInfo" (click)="closeContactInfo()">
    <div class="sidebar-panel animate-slide-in-right" (click)="$event.stopPropagation()">
        <div class="group-info-header">
            <button class="close-btn" (click)="closeContactInfo()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5"></path>
                    <path d="M12 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div class="header-titles">
                <h3>Contact info</h3>
            </div>
        </div>

        <div class="group-info-content">
            <div class="group-info-main">
                <div class="group-large-avatar contact-large-avatar">
                    <img *ngIf="selectedUser?.avatar" [src]="getAvatarUrl(selectedUser?.avatar)">
                    <div *ngIf="!selectedUser?.avatar" class="avatar-placeholder">
                        {{ (selectedUser?.username || '').charAt(0).toUpperCase() }}
                    </div>
                </div>
                <h2>{{ selectedUser?.fullName || selectedUser?.username }}</h2>
                <span class="group-status-text" [class.online]="selectedUser?.isOnline">{{
                    selectedUser?.isOnline ?
                    'Online' : 'Offline' }}</span>

                <!-- Quick Actions like in image -->
                <div class="contact-quick-actions">
                    <div class="q-action ripple" (click)="toastService.show('Search feature coming soon')">
                        <div class="q-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e"
                                stroke-width="2.5">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                        </div>
                        <span>Search</span>
                    </div>
                    <div class="q-action ripple" (click)="onVideoCall(); closeContactInfo()">
                        <div class="q-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e"
                                stroke-width="2.5">
                                <path d="M23 7l-7 5 7 5V7z"></path>
                                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                            </svg>
                        </div>
                        <span>Video</span>
                    </div>
                    <div class="q-action ripple" (click)="onVoiceCall(); closeContactInfo()">
                        <div class="q-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e"
                                stroke-width="2.5">
                                <path
                                    d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z">
                                </path>
                            </svg>
                        </div>
                        <span>Voice</span>
                    </div>
                </div>
            </div>

            <div class="group-info-section">
                <div class="info-item">
                    <div class="info-label">About</div>
                    <div class="info-value about-text">{{ selectedUser?.about || '(^._.^) ram ram bhai saryane'
                        }}</div>
                </div>
            </div>

            <div class="group-info-actions">
                <button class="exit-action-btn" (click)="blockUser()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                        <line x1="12" y1="2" x2="12" y2="12"></line>
                    </svg>
                    <span>Block {{ selectedUser?.fullName || selectedUser?.username }}</span>
                </button>
            </div>
        </div>
    </div>
</div>